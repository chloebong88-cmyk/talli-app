<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Talli v28 - FINAL! Real-time Calendar Updates + Smart AI Scheduling -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI-powered group project management for students. Plan, track, and assess teamwork effortlessly.">
    <meta name="theme-color" content="#4A6B5A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Talli">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="shortcut icon" type="image/png" href="logo.png">
    <title>Talli - Group Project Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK - Load with defer to ensure proper loading -->
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4A6B5A; /* Dark sage green from logo */
            --secondary: #2F4538; /* Darker green */
            --accent: #7FA08C; /* Lighter sage */
            --bg: #F5F7F6;
            --text: #2F4538;
            --text-light: #6B7F75;
            --border: #D4E0D9;
            --success: #4A6B5A;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #E8ECE9 0%, #F5F7F6 100%);
            color: var(--text);
            overflow: hidden; /* Prevent actual scrolling */
            height: 100vh;
            position: fixed; /* Lock body in place */
            width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Logo */
        .logo-container {
            position: fixed;
            top: 2rem;
            left: 2rem;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }
        
        /* Hide logo on calendar page */
        .logo-container.calendar-locked {
            pointer-events: none;
            opacity: 0.3;
            cursor: not-allowed;
        }

        .logo {
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: transform 0.3s, opacity 0.3s;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(74, 107, 90, 0.2);
        }

        .logo:hover {
            transform: scale(1.1);
        }
        
        /* Locked logo on calendar page */
        .calendar-locked .logo {
            cursor: not-allowed;
        }
        
        .calendar-locked .logo:hover {
            transform: none;
        }

        /* Progress indicator - top right, aligned with logo */
        .progress-circle-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 1000;
            background: white;
            padding: 0.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(74, 107, 90, 0.2);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Ensure page doesn't scroll */
            .page {
                overflow: hidden;
                padding: 1rem !important;
                justify-content: center !important;
            }

            .hero-title {
                font-size: 2.2rem !important;
                line-height: 1.15 !important;
                margin-bottom: 0.5rem !important;
            }

            .hero-subtitle {
                font-size: 1.1rem !important;
                margin-top: 0.25rem !important;
            }

            .question-title {
                font-size: 1.8rem !important;
            }

            .question-page {
                max-width: 90%;
                padding: 0 1rem;
                max-height: 85vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            /* Better date picker for mobile */
            .date-input-container {
                width: 100%;
                display: flex;
                justify-content: center;
                padding: 0 1rem;
            }

            .date-input {
                padding: 0.75rem !important;
                font-size: 1rem !important;
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }

            /* Center buttons properly */
            .button-container {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                align-items: center;
                width: 100%;
            }

            .upload-btn, .submit-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
                padding: 1rem 2rem;
                font-size: 1rem;
            }

            .logo {
                width: 50px !important;
                height: 50px !important;
            }

            .logo-container {
                top: 1rem !important;
                left: 0.75rem !important;
            }

            .progress-circle-container {
                top: 1rem !important;
                right: 0.75rem !important;
            }

            .progress-circle-container svg {
                width: 50px;
                height: 50px;
            }

            #progressText {
                font-size: 12px !important;
            }

            /* CALENDAR - FIT IPHONE SCREEN */
            .calendar-container {
                padding: 0.5rem;
                max-width: 100vw;
                width: 100%;
                max-height: 80vh;
                margin: 0;
                border-radius: 12px;
            }

            .calendar-header {
                margin-bottom: 0.5rem;
                padding: 0;
            }

            .calendar-title {
                font-size: 1.1rem;
                margin-bottom: 0.25rem;
            }

            .export-calendar-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
                margin: 0.25rem auto;
            }
            
            .calendar-action-btn {
                padding: 0.4rem 0.7rem;
                font-size: 0.75rem;
                gap: 0.3rem;
            }
            
            .calendar-action-btn svg {
                width: 14px;
                height: 14px;
            }
            
            .peer-assessment-btn {
                width: 100%;
                justify-content: center;
                margin-top: 0.25rem;
            }

            .calendar-grid {
                gap: 0.2rem;
                max-height: calc(80vh - 120px);
                grid-template-columns: repeat(7, 1fr);
            }

            .calendar-day {
                min-height: 48px;
                max-height: 60px;
                padding: 0.25rem;
                font-size: 0.7rem;
                border-width: 1px;
                border-radius: 6px;
            }

            .day-number {
                font-size: 0.7rem;
                font-weight: 700;
                margin-bottom: 0.15rem;
            }

            /* Hide full task list on mobile */
            .task-list-desktop {
                display: none !important;
            }

            /* Show icon dots on mobile - just colored squares */
            .task-icons-mobile {
                display: flex !important;
                flex-wrap: wrap;
                gap: 2px;
                justify-content: center;
                align-items: center;
            }

            .task-icon-dot {
                width: 10px;
                height: 10px;
                border-radius: 2px;
            }

            .task-icon-more {
                font-size: 0.5rem;
                font-weight: 700;
                color: #6B7280;
            }

            .task-indicator {
                display: none;
            }

            .legend {
                gap: 0.4rem;
                flex-wrap: wrap;
                margin-top: 0.4rem;
                justify-content: center;
                padding: 0 0.5rem;
            }

            .legend-item {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }

            .legend-item.clickable span::after {
                content: '' !important;
            }

            /* Hide sync message on mobile */
            .calendar-header > div[style*="font-size: 0.8rem"] {
                display: none !important;
            }

            /* Smaller calendar title on mobile */
            .calendar-title {
                font-size: 1.3rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* Smaller action buttons on mobile */
            .calendar-action-btn {
                padding: 0.4rem 0.6rem !important;
                font-size: 0.7rem !important;
            }

            .calendar-action-btn svg {
                width: 12px !important;
                height: 12px !important;
            }

            /* Stack Peer Assessment below other buttons */
            .peer-assessment-btn {
                width: 100%;
                max-width: 200px;
            }

            /* Review screen improvements for mobile */
            .review-screen {
                padding: 1rem;
                max-width: 95%;
                width: 95%;
                max-height: 85vh;
                overflow: hidden;
            }

            .review-header {
                margin-bottom: 1rem;
            }

            .review-title {
                font-size: 1.5rem;
            }

            .review-subtitle {
                font-size: 0.9rem;
            }

            .review-tasks-list {
                max-height: calc(85vh - 200px); /* Room for header + actions */
            }

            .review-task-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .review-task-input {
                width: 100% !important;
                min-height: 50px;
            }

            .review-task-name {
                min-height: 70px;
            }

            /* Task modal for mobile */
            .task-modal-content {
                padding: 1.5rem;
                width: 90%;
                max-width: 400px;
            }

            .team-input {
                padding: 0.75rem !important;
                font-size: 1rem !important;
            }

            .member-bubble {
                padding: 0.6rem 0.9rem !important;
                font-size: 0.9rem !important;
            }

            /* Hide peer assessment button on mobile */
            #peerAssessmentBtn {
                display: none !important;
            }

            /* MOBILE: Smaller approve and add task buttons */
            .add-task-btn {
                padding: 0.5rem 1rem !important;
                font-size: 0.85rem !important;
                border-radius: 8px !important;
            }

            .approve-tasks-btn {
                padding: 0.6rem 1rem !important;
                font-size: 0.85rem !important;
                border-radius: 8px !important;
                line-height: 1.2 !important;
            }

            .review-actions {
                gap: 0.5rem !important;
                flex-wrap: wrap !important;
                justify-content: center !important;
            }

            /* MOBILE: Smaller creating your project page */
            .loading-title, #page7 h2 {
                font-size: 1.6rem !important;
            }

            .loading-subtitle, #page7 p {
                font-size: 0.9rem !important;
            }

            #page7 .question-page {
                transform: scale(0.95) !important;
            }

            /* Mobile chatbot - centered and full width */
            #chatbotPanel {
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%);
                width: 95% !important;
                max-width: 380px !important;
                bottom: 1rem !important;
                height: 60vh !important;
                max-height: 500px !important;
            }

            #chatbotButton {
                bottom: 1rem !important;
                right: 1rem !important;
                width: 50px !important;
                height: 50px !important;
            }
        }

        @media (max-width: 480px) {
            .hero-title {
                font-size: 1.6rem !important;
            }

            .hero-subtitle {
                font-size: 0.9rem !important;
            }

            .question-title {
                font-size: 1.4rem;
            }

            /* Even more compact calendar for small phones */
            .calendar-container {
                max-height: 75vh;
                padding: 0.4rem;
            }

            .calendar-title {
                font-size: 1rem;
            }

            .calendar-grid {
                max-height: calc(75vh - 100px);
                gap: 0.15rem;
            }

            .calendar-day {
                min-height: 45px;
                max-height: 55px;
                padding: 0.15rem;
            }

            .day-number {
                font-size: 0.6rem;
            }

            .task-indicator {
                font-size: 0.4rem;
                padding: 0.05rem 0.15rem;
            }

            .legend-item {
                font-size: 0.6rem;
                padding: 0.15rem 0.3rem;
            }

            /* Prevent horizontal scroll */
            .date-input {
                width: 100%;
                max-width: calc(100vw - 3rem);
            }

            .logo {
                width: 50px !important;
                height: 50px !important;
            }

            .logo-container {
                top: 1rem !important;
                left: 0.75rem !important;
            }

            .progress-circle-container {
                top: 1rem !important;
                right: 0.75rem !important;
            }

            .progress-circle-container svg {
                width: 45px;
                height: 45px;
            }
        }

        /* Landscape mode fixes */
        @media (max-width: 768px) and (orientation: landscape) {
            .calendar-container {
                max-height: 85vh;
            }

            .calendar-grid {
                max-height: calc(85vh - 100px);
            }

            .calendar-day {
                min-height: 40px;
                max-height: 50px;
            }
        }

        /* Export calendar button */
        .export-calendar-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin: 1rem auto;
            display: block;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(74, 107, 90, 0.3);
        }

        .export-calendar-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 107, 90, 0.4);
        }
        
        /* Calendar action buttons */
        .calendar-action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(74, 107, 90, 0.2);
        }
        
        .calendar-action-btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 107, 90, 0.3);
        }
        
        .calendar-action-btn:active {
            transform: translateY(0);
        }
        
        .calendar-action-btn svg {
            flex-shrink: 0;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #chatbotButton:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        /* Drag and drop styles */
        .calendar-day.drag-over {
            border-color: var(--primary);
            border-width: 3px;
            border-style: dashed;
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(74, 107, 90, 0.3);
        }

        .task-indicator.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .task-indicator {
            cursor: grab;
        }

        .task-indicator:active {
            cursor: grabbing;
        }

        /* Full-screen pages */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease, transform 0.6s ease;
            background: transparent; /* Fully transparent to show body gradient */
        }

        .page.hidden {
            opacity: 0;
            transform: translateY(-30px);
            pointer-events: none;
        }

        .page.active {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* To-Do Sidebar */
        .todo-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            max-width: 90vw;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 2000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .todo-sidebar.open {
            right: 0;
        }

        .todo-header {
            padding: 1.5rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .todo-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .todo-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }

        .todo-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .todo-week-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: var(--bg);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .todo-item:hover {
            background: #E8ECE9;
        }

        .todo-item.completing {
            animation: taskComplete 0.5s ease forwards;
        }

        @keyframes taskComplete {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); background: #D4EDDA; }
            100% { transform: translateX(100%); opacity: 0; height: 0; padding: 0; margin: 0; }
        }

        .todo-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .todo-item:hover .todo-checkbox {
            background: rgba(74, 107, 90, 0.1);
        }

        .todo-checkbox.checked {
            background: var(--primary);
            color: white;
        }

        .todo-item-content {
            flex: 1;
        }

        .todo-item-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .todo-item-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .todo-item.completed .todo-item-name {
            text-decoration: line-through;
            color: var(--text-light);
        }

        .todo-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .done-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: doneContainer 1s ease forwards;
        }

        .done-checkmark {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4A6B5A, #2F4538);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: checkBounce 0.6s ease;
            box-shadow: 0 10px 40px rgba(74, 107, 90, 0.4);
        }

        .done-checkmark svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            animation: checkDraw 0.4s ease 0.2s forwards;
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
        }

        .done-text {
            margin-top: 1rem;
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary);
            animation: textPop 0.4s ease 0.3s forwards;
            opacity: 0;
            transform: scale(0.5);
        }

        .done-subtext {
            font-size: 1rem;
            color: var(--text-light);
            animation: textPop 0.4s ease 0.5s forwards;
            opacity: 0;
        }

        @keyframes doneContainer {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes checkBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        @keyframes checkDraw {
            to { stroke-dashoffset: 0; }
        }

        @keyframes textPop {
            to { opacity: 1; transform: scale(1); }
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 2999;
            pointer-events: none;
        }

        @keyframes confettiFall {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 1;
            }
            100% { 
                transform: translateY(400px) rotate(720deg); 
                opacity: 0;
            }
        }

        .todo-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .todo-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        /* Make member names clickable in legend */
        .legend-item.clickable {
            cursor: pointer;
            padding: 0.4rem 0.6rem;
            border-radius: 10px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .legend-item.clickable:hover {
            background: rgba(74, 107, 90, 0.15);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .legend-item.clickable span::after {
            content: ' â†’';
            opacity: 0.4;
            font-size: 0.85rem;
            transition: opacity 0.2s ease;
        }

        .legend-item.clickable:hover span::after {
            opacity: 1;
        }

        /* Click hint tooltip */
        .legend-item.clickable[data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--secondary);
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            margin-bottom: 0.5rem;
            z-index: 100;
        }

        /* Progress indicator (1/5 text) */
        .progress-indicator {
            position: fixed;
            top: 2rem;
            right: 2rem;
            font-weight: 700;
            color: var(--text);
            font-size: 1.1rem;
            z-index: 1000;
            background: white;
            padding: 0.75rem 1.25rem;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(74, 107, 90, 0.2);
            min-width: 60px;
            text-align: center;
        }

        /* Scroll arrows */
        .scroll-arrows {
            position: absolute;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            cursor: pointer;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
            40% { transform: translateX(-50%) translateY(-10px); }
            60% { transform: translateX(-50%) translateY(-5px); }
        }

        .scroll-arrow {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 15px solid var(--primary);
            opacity: 0.7;
        }

        .scroll-arrows:hover .scroll-arrow {
            opacity: 1;
        }

        /* Swipe hint - only on mobile */
        .swipe-hint {
            display: none;
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .swipe-hint {
                display: block;
                font-size: 0.75rem;
                text-align: center;
            }
            
            .scroll-arrows {
                bottom: 6rem;
                align-items: center;
            }
            
            .scroll-arrow {
                border-left-width: 10px;
                border-right-width: 10px;
                border-top-width: 10px;
            }
        }

        /* Page 1: Hero/Hook */
        .hero-text {
            text-align: center;
            max-width: 900px;
        }

        .hero-title {
            font-size: 5rem;
            font-weight: 900;
            line-height: 1.1;
            color: var(--secondary);
            margin-bottom: 2rem;
            animation: slideUp 0.8s ease-out 0.2s both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-subtitle {
            font-size: 2rem;
            color: var(--text-light);
            font-weight: 600;
            animation: slideUp 0.8s ease-out 0.4s both;
        }

        .hero-features {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            margin-top: 2rem;
            animation: slideUp 0.8s ease-out 0.6s both;
        }

        .hero-feature {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 500;
        }

        .hero-check {
            color: var(--primary);
            font-weight: 900;
            font-size: 1.3rem;
        }

        @media (max-width: 768px) {
            .hero-features {
                margin-top: 0.75rem;
                margin-bottom: 0;
                gap: 0.3rem;
                align-items: center;
                padding: 0 1rem;
            }
            
            .hero-feature {
                font-size: 0.8rem;
            }
            
            .hero-check {
                font-size: 0.85rem;
                min-width: 14px;
            }

            .hero-text {
                padding: 0 1rem;
                text-align: center;
            }
        }

        /* Question pages (2-5) */
        .question-page {
            max-width: 700px;
            width: 100%;
            background: transparent;
            padding: 2rem;
            border-radius: 20px;
        }

        .question-number {
            font-size: 1.2rem;
            color: #3A5548; /* Darker green than --primary */
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
        }

        .question-title {
            font-size: 3.5rem;
            font-weight: 900;
            text-align: center;
            color: #1F2E28; /* Darker green than --secondary */
            margin-bottom: 3rem;
            line-height: 1.2;
        }

        /* Team members input */
        .team-input-container {
            width: 100%;
        }

        .team-input {
            width: 100%;
            padding: 1.5rem;
            font-size: 1.5rem;
            border: 3px solid var(--border);
            border-radius: 16px;
            font-family: 'Archivo', sans-serif;
            transition: all 0.3s;
            text-align: center;
        }

        .team-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        .team-members {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }

        .member-bubble {
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 3px solid;
            color: #2F4538;
        }

        /* Color-code bubbles to match calendar - each person gets their color */
        .member-bubble:nth-child(1) { 
            background: #FFB3E6; 
            border-color: #E91E8C; 
        }
        .member-bubble:nth-child(2) { 
            background: #FFE5B3; 
            border-color: #FFB02E; 
        }
        .member-bubble:nth-child(3) { 
            background: #B3D9FF; 
            border-color: #2E7DFF; 
        }
        .member-bubble:nth-child(4) { 
            background: #D4B3FF; 
            border-color: #8E2EFF; 
        }
        .member-bubble:nth-child(5) { 
            background: #B3FFD9; 
            border-color: #2EFF8E; 
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .remove-member {
            cursor: pointer;
            font-weight: 900;
            color: #2F4538;
            font-size: 1.5rem;
            line-height: 1;
            transition: transform 0.2s;
            opacity: 0.6;
        }

        .remove-member:hover {
            transform: scale(1.3);
            opacity: 1;
        }

        /* Date picker */
        .date-input-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .date-input {
            width: 100%;
            max-width: 400px;
            padding: 1.5rem;
            font-size: 1.5rem;
            border: 3px solid var(--border);
            border-radius: 16px;
            font-family: 'Archivo', sans-serif;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        /* Brief input */
        .brief-input {
            width: 100%;
            min-height: 200px;
            max-height: 35vh;
            padding: 1.5rem;
            font-size: 1.2rem;
            border: 3px solid var(--border);
            border-radius: 16px;
            font-family: 'Archivo', sans-serif;
            resize: vertical;
            transition: all 0.3s;
        }

        .brief-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        .brief-options {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Mobile: stack buttons vertically */
        @media (max-width: 768px) {
            .brief-input {
                min-height: 150px; /* Shorter on mobile */
                max-height: 40vh; /* Don't take up whole screen */
                font-size: 1rem;
            }

            .brief-options {
                flex-direction: column;
                align-items: center;
                margin-top: 1rem;
            }
            
            .brief-options .upload-btn,
            .brief-options .submit-btn {
                display: flex !important; /* Force display */
                width: 100%;
                max-width: 300px;
            }
        }

        .upload-btn {
            padding: 1.25rem 2.5rem;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            display: inline-block;
            text-align: center;
            box-shadow: 0 4px 16px rgba(74, 107, 90, 0.25);
        }

        .upload-btn:hover {
            background: #243629;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 107, 90, 0.35);
        }

        .submit-btn {
            padding: 1.25rem 2.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 4px 16px rgba(74, 107, 90, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .submit-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 107, 90, 0.35);
        }

        .submit-btn svg {
            flex-shrink: 0;
        }

        /* Loading page */
        .loading-page {
            text-align: center;
            max-width: 600px;
        }

        .loading-title {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 1rem;
        }

        .loading-subtitle {
            font-size: 1.5rem;
            color: var(--text-light);
            margin-bottom: 3rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto 2rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 50%, var(--primary) 100%);
            background-size: 200% 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-steps {
            text-align: left;
            margin-top: 2rem;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            font-size: 1.1rem;
            color: var(--text-light);
            opacity: 0.4;
            transition: all 0.3s;
        }

        .loading-step.active {
            color: var(--primary);
            opacity: 1;
            font-weight: 700;
        }

        .loading-step.complete {
            color: var(--success);
            opacity: 1;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
        }

        .loading-step.complete .step-icon {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* Calendar page */
        .calendar-container {
            max-width: 98vw;
            max-height: 88vh;
            width: 100%;
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 20px 60px rgba(74, 107, 90, 0.15);
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            text-align: center;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .calendar-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 0.75rem;
        }
        /* Day of week header */
.calendar-weekday-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    padding: 0 0.5rem;
}

.weekday-label {
    text-align: center;
    font-weight: 900;
    font-size: 0.9rem;
    color: var(--primary);
    padding: 0.5rem 0;
    background: rgba(74, 107, 90, 0.1);
    border-radius: 6px;
}

/* Mobile weekday headers */
@media (max-width: 768px) {
    .calendar-weekday-header {
        gap: 0.2rem;
        padding: 0;
    }
    
    .weekday-label {
        font-size: 0.7rem;
        padding: 0.3rem 0;
    }
}

@media (max-width: 480px) {
    .weekday-label {
        font-size: 0.65rem;
        padding: 0.25rem 0;
    }
}
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            flex: 1;
            align-content: start;
            max-height: calc(88vh - 180px);
            overflow-y: auto;
        }

        .calendar-day {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            position: relative;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            min-height: 90px;
            max-height: 110px;
            overflow: hidden;
        }
            position: relative;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }

        .calendar-day:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.has-task {
            border-width: 3px;
        }

        .day-number {
            font-weight: 900;
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 0.25rem;
            flex-shrink: 0;
        }

        .task-indicator {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            margin-top: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #1A1F1C; /* Dark text for readability on light backgrounds */
        }

        /* Desktop: show task list, hide mobile icons */
        .task-list-desktop {
            display: block;
        }

        .task-icons-mobile {
            display: none;
        }

        /* Color coding for team members - bright, distinct colors */
        .member-color-1 { background: #FFB3E6; border-color: #E91E8C; }
        .member-color-2 { background: #FFE5B3; border-color: #FFB02E; }
        .member-color-3 { background: #B3D9FF; border-color: #2E7DFF; }
        .member-color-4 { background: #D4B3FF; border-color: #8E2EFF; }
        .member-color-5 { background: #B3FFD9; border-color: #2EFF8E; }
        .member-color-6 { background: #E5E7EB; border-color: #9CA3AF; } /* Rest Day */

        .legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .legend-hint {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .legend-hint {
                font-size: 0.7rem;
                margin-top: 0.3rem;
            }
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .hidden {
            display: none;
        }

        /* Task Detail Modal */
        .task-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .task-modal.active {
            display: flex;
        }

        .task-modal-content {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 2rem;
        }

        .modal-date {
            font-size: 2rem;
            font-weight: 900;
            color: var(--secondary);
        }

        .close-modal-btn {
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .close-modal-btn:hover {
            color: var(--primary);
        }

        .task-detail-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border);
        }

        .task-detail-header {
            display: flex;
            align-items: start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-detail-info {
            flex: 1;
        }

        .task-detail-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .task-detail-assignee {
            display: inline-block;
            background: var(--accent);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .task-detail-description {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }

        .task-notes-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border);
        }

        .task-notes-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--text);
        }

        .task-notes-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Archivo', sans-serif;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 60px;
        }

        .task-notes-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .save-notes-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .save-notes-btn:hover {
            background: #059669;
        }

        /* Task Review/Edit Screen */
        .review-screen {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden; /* Prevent outer scroll */
        }

        .review-header {
            text-align: center;
            margin-bottom: 2rem;
            flex-shrink: 0; /* Don't shrink header */
        }

        .review-tasks-list {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            padding-right: 0.5rem;
            min-height: 0; /* Allow flexbox to shrink */
        }

        .review-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border);
            flex-shrink: 0; /* Don't shrink actions */
        }

        .review-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .review-subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .review-task-item {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .review-task-item:hover {
            border-color: var(--primary);
        }

        .review-task-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: start;
        }

        /* Fix review task proportions for mobile ONLY */
        @media (max-width: 768px) {
            .review-task-row {
                grid-template-columns: 1fr !important;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            /* Tablet: better proportions */
            .review-task-row {
                grid-template-columns: 3fr 1.5fr 1.5fr auto;
            }
        }

        .review-task-input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Archivo', sans-serif;
            font-size: 0.95rem;
            min-height: 60px;
            resize: vertical;
        }

        .review-task-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .review-task-name {
            min-height: 80px;
        }

        .delete-task-btn {
            padding: 0.5rem 1rem;
            background: #EF4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .delete-task-btn:hover {
            background: #DC2626;
        }

        .review-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border);
        }

        .add-task-btn {
            padding: 0.75rem 1.5rem;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }

        .add-task-btn:hover {
            background: #003A66;
        }

        .approve-tasks-btn {
            padding: 1rem 2.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 900;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .approve-tasks-btn:hover {
            background: #E85A28;
            transform: translateY(-2px);
        }

        /* File input styling */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Progress Indicator -->
    <div class="progress-indicator" id="progressIndicator"></div>

    <!-- Logo (top left) -->
    <div class="logo-container" id="logoContainer">
        <img src="logo.png" alt="Talli" class="logo" onclick="resetApp()">
    </div>

    <!-- Progress Circle (shows page count) -->
    <div class="progress-circle-container" id="progressCircle" style="display: none;">
        <svg width="72" height="72" viewBox="0 0 72 72">
            <circle cx="36" cy="36" r="30" fill="none" stroke="#D4E0D9" stroke-width="5"/>
            <circle id="progressCircleFill" cx="36" cy="36" r="30" fill="none" stroke="#4A6B5A" stroke-width="5" 
                    stroke-dasharray="188" stroke-dashoffset="188" transform="rotate(-90 36 36)" 
                    style="transition: stroke-dashoffset 0.5s ease;"/>
            <text x="36" y="41" text-anchor="middle" font-size="16" font-weight="900" fill="var(--text)" id="progressText">0%</text>
        </svg>
    </div>

    <!-- Page 1: Hero/Hook -->
    <div class="page active" id="page1" style="opacity: 1; transform: translateY(0);">
        <div class="hero-text">
            <h1 class="hero-title">Stop arguing about who did what.</h1>
            <p class="hero-subtitle">We plan your project. You actually finish it.</p>
            <div class="hero-features">
                <div class="hero-feature">
                    <span class="hero-check">âœ“</span>
                    <span>One app. No more juggling tools.</span>
                </div>
                <div class="hero-feature">
                    <span class="hero-check">âœ“</span>
                    <span>AI splits tasks fairly. No debates.</span>
                </div>
                <div class="hero-feature">
                    <span class="hero-check">âœ“</span>
                    <span>Built-in peer assessment. Proof of who did what.</span>
                </div>
            </div>
        </div>
        <div class="scroll-arrows" onclick="scrollToPage(2)">
            <span class="swipe-hint">Swipe up to start</span>
            <div class="scroll-arrow"></div>
            <div class="scroll-arrow"></div>
        </div>
    </div>

    <!-- Page 2: Team Members -->
    <div class="page hidden" id="page2">
        <div class="question-page">
            <div class="question-number">STEP 1 OF 5</div>
            <h2 class="question-title">Who's on your team?</h2>
            <div class="team-input-container">
                <input 
                    type="text" 
                    class="team-input" 
                    id="teamInput" 
                    placeholder="Type a name and press Enter"
                    onkeypress="addTeamMember(event)"
                    autocomplete="off"
                    autocapitalize="words"
                >
                <div class="team-members" id="teamMembers"></div>
            </div>
        </div>
        <div class="scroll-arrows" onclick="scrollToPage(3)">
            <div class="scroll-arrow"></div>
            <div class="scroll-arrow"></div>
        </div>
    </div>

    <!-- Page 3: Start Date -->
    <div class="page hidden" id="page3">
        <div class="question-page">
            <div class="question-number">STEP 2 OF 5</div>
            <h2 class="question-title">When do you start?</h2>
            <div class="date-input-container">
                <input type="date" class="date-input" id="startDate">
            </div>
        </div>
        <div class="scroll-arrows" onclick="scrollToPage(4)">
            <div class="scroll-arrow"></div>
            <div class="scroll-arrow"></div>
        </div>
    </div>

    <!-- Page 4: End Date -->
    <div class="page hidden" id="page4">
        <div class="question-page">
            <div class="question-number">STEP 3 OF 5</div>
            <h2 class="question-title">When's it due?</h2>
            <div class="date-input-container">
                <input type="date" class="date-input" id="endDate">
            </div>
        </div>
        <div class="scroll-arrows" onclick="scrollToPage(5)">
            <div class="scroll-arrow"></div>
            <div class="scroll-arrow"></div>
        </div>
    </div>

    <!-- Page 5: Assignment Brief -->
    <div class="page hidden" id="page5">
        <div class="question-page">
            <div class="question-number">STEP 4 OF 5</div>
            <h2 class="question-title">What's the assignment?</h2>
            <textarea 
                class="brief-input" 
                id="briefInput" 
                placeholder="Paste your assignment brief here. Be as specific as possible for more accurate tasks!"
            ></textarea>
            <div class="brief-options button-container">
                <label for="fileUpload" class="upload-btn">
                    ðŸ“Ž Upload Document
                </label>
                <input type="file" id="fileUpload" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(event)">
            </div>
        </div>
        <div class="scroll-arrows" onclick="scrollToPage(6)">
            <div class="scroll-arrow"></div>
            <div class="scroll-arrow"></div>
        </div>
    </div>

    <!-- Page 6: Team Member Details (FINAL STEP) -->
    <div class="page hidden" id="page6">
        <div class="question-page">
            <div class="question-number" id="page6StepNumber">STEP 5 OF 5</div>
            <h2 class="question-title" id="page6Title">Who are you?</h2>
            <p id="page6Subtitle" style="text-align: center; color: var(--text-light); margin-bottom: 2rem; font-size: 1rem;">Click your name to add your availability</p>
            <div id="teamMemberSelector" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 2rem;">
                <!-- Will be populated with clickable member names -->
            </div>
            <div id="selectedMemberDetails" style="display: none; margin-bottom: 1rem;">
                <!-- Will show selected member's form -->
            </div>
            <button class="submit-btn" id="generateButton" onclick="generateProject()" style="margin: 0 auto 1rem; display: flex;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" fill="white"/>
                    <path d="M18 4L18.5 6L20.5 6.5L18.5 7L18 9L17.5 7L15.5 6.5L17.5 6L18 4Z" fill="white" opacity="0.8"/>
                    <path d="M6 14L6.5 16L8.5 16.5L6.5 17L6 19L5.5 17L3.5 16.5L5.5 16L6 14Z" fill="white" opacity="0.8"/>
                </svg>
                <span id="generateButtonText">Generate Project</span>
            </button>
        </div>
    </div>

    <!-- Page 7: Loading -->
    <div class="page hidden" id="page7">
        <div class="loading-page">
            <h2 class="loading-title">Creating your project...</h2>
            <p class="loading-subtitle" id="loadingMessage">This may take 30-60 seconds - analyzing your brief...</p>
            
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
            </div>

            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <div class="step-icon">1</div>
                    <span>Reading assignment brief</span>
                </div>
                <div class="loading-step" id="step2">
                    <div class="step-icon">2</div>
                    <span>Breaking down into tasks</span>
                </div>
                <div class="loading-step" id="step3">
                    <div class="step-icon">3</div>
                    <span>Assigning to team members</span>
                </div>
                <div class="loading-step" id="step4">
                    <div class="step-icon">4</div>
                    <span>Creating your timeline</span>
                </div>
            </div>
            
            <p style="margin-top: 2rem; color: var(--text-light); font-size: 0.9rem; text-align: center;">
                â±ï¸ This usually takes 10-30 seconds
            </p>
        </div>
    </div>

    <!-- Page 8: Calendar -->
    <div class="page hidden" id="page8">
        <div class="calendar-container">
            <div class="calendar-header">
    <div class="calendar-title" id="projectTitle">Your Project Timeline</div>
    <!-- Hidden project ID for debugging -->
    <div id="currentProjectIdDisplay" style="display: none;"></div>
    <div style="font-size: 0.8rem; color: #6B7F75; margin-bottom: 0.75rem;">
        Not seeing updates? Refresh the page to sync
    </div>
    <div style="display: flex; gap: 0.5rem; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 0.75rem;">
        <button class="calendar-action-btn" onclick="exportToGoogleCalendar()" title="Export to Google Calendar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Export
        </button>
        <button class="calendar-action-btn" onclick="showShareLinkAgain()" title="Get shareable project link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
            Share
        </button>
        <button class="calendar-action-btn peer-assessment-btn" onclick="window.location.href='peer-assessment.html'" title="Peer Assessment">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Peer Assessment
        </button>
    </div>
    <div class="legend" id="legend"></div>
    <div class="legend-hint">ðŸ‘† Tap your name to see your to-do list</div>
</div>
<!-- Day of week headers -->
<div class="calendar-weekday-header">
    <div class="weekday-label">M</div>
    <div class="weekday-label">T</div>
    <div class="weekday-label">W</div>
    <div class="weekday-label">T</div>
    <div class="weekday-label">F</div>
    <div class="weekday-label">S</div>
    <div class="weekday-label">S</div>
</div>
<div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="task-modal" id="taskModal" onclick="if(event.target === this) closeTaskModal()">
        <div class="task-modal-content">
            <div class="modal-header-row">
                <div class="modal-date" id="modalDate"></div>
                <span class="close-modal-btn" onclick="closeTaskModal()">&times;</span>
            </div>
            <div id="modalTasksList"></div>
        </div>
    </div>

    <!-- Page 9: Review & Edit Tasks -->
    <div class="page hidden" id="page9">
        <div class="review-screen">
            <div class="review-header">
                <h2 class="review-title">Review Your Tasks</h2>
                <p class="review-subtitle">Edit, delete, or add tasks before finalizing your project</p>
            </div>
            <div class="review-tasks-list" id="reviewTasksList"></div>
            <div class="review-actions">
                <button class="add-task-btn" onclick="addNewTask()">+ Add Task</button>
                <button class="approve-tasks-btn" onclick="approveTasks()">âœ“ Approve & Continue</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize current page
        window.currentPage = 1;
        
        // ============================================
        // FIREBASE REAL-TIME COLLABORATION
        // ============================================
        
        // Wait for Firebase SDK to load with retry logic
        function initializeFirebase() {
            // Check if Firebase is loaded
            if (typeof firebase === 'undefined') {
                console.log('â³ Waiting for Firebase SDK...');
                // Retry after 500ms
                setTimeout(initializeFirebase, 500);
                return;
            }
            
            console.log('ðŸ”¥ Firebase SDK loaded, initializing...');
            
            try {
                // Initialize Firebase
                const firebaseConfig = {
                    apiKey: "AIzaSyCHF8RoJqcqczJd6R3Jkhdk6gmEWrqxqpQ",
                    authDomain: "tally-50560.firebaseapp.com",
                    projectId: "tally-50560",
                    storageBucket: "tally-50560.firebasestorage.app",
                    messagingSenderId: "347012105530",
                    appId: "1:347012105530:web:54f974b879b691734a3c03"
                };
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                window.db = firebase.firestore();
                window.firebaseReady = true;
                
                console.log('âœ… Firebase initialized for real-time collaboration');
                
                // Check for project ID on load
                const projectId = getProjectIdFromURL();
                if (projectId) {
                    console.log('ðŸ”— Loading shared project...');
                    loadFirebaseProject(projectId);
                }
            } catch (error) {
                console.error('âŒ Firebase init error:', error);
                console.log('âš ï¸ App will work without real-time sync');
                window.firebaseReady = false;
            }
        }
        
        // Start trying to initialize Firebase
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeFirebase);
        } else {
            initializeFirebase();
        }
        
        let currentProjectId = null;
        let unsubscribeListener = null;
        
        // Make currentProjectId accessible from console for debugging
        window.getCurrentProjectId = () => currentProjectId;
        
        // Update project ID display
        function updateProjectIdDisplay() {
            const projectIdDisplay = document.getElementById('currentProjectIdDisplay');
            if (projectIdDisplay) {
                if (currentProjectId) {
                    projectIdDisplay.textContent = currentProjectId;
                    projectIdDisplay.style.color = '#10B981'; // Green when connected
                    console.log('ðŸ“Œ Project ID display updated:', currentProjectId);
                } else {
                    projectIdDisplay.textContent = 'Not connected';
                    projectIdDisplay.style.color = '#EF4444'; // Red when not connected
                    console.log('ðŸ“Œ Project ID display: Not connected');
                }
            } else {
                console.log('âš ï¸ Project ID display element not found');
            }
        }
        
        // Get project ID from URL
        function getProjectIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('project');
        }
        
        // Set project ID in URL
        function setProjectIdInURL(projectId) {
            const url = new URL(window.location);
            url.searchParams.set('project', projectId);
            window.history.pushState({}, '', url);
        }
        
        // Create new project in Firebase
        async function createFirebaseProject() {
            if (!window.firebaseReady || !window.db) {
                console.log('âš ï¸ Firebase not available - project will not be saved');
                alert('Firebase not available. Project will work but cannot be shared. Please check your internet connection and reload the page.');
                return null;
            }
            
            try {
                console.log('ðŸ“ Creating new project...');
                
                const projectRef = await window.db.collection('projects').add({
                    members: projectData.members,
                    memberDetails: projectData.memberDetails,
                    startDate: projectData.startDate ? projectData.startDate.toISOString() : null,
                    endDate: projectData.endDate ? projectData.endDate.toISOString() : null,
                    brief: getTruncatedBrief(projectData.brief),
                    tasks: projectData.tasks,
                    taskNotes: projectData.taskNotes || {},
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentProjectId = projectRef.id;
                setProjectIdInURL(currentProjectId);
                updateProjectIdDisplay(); // Update display immediately
                
                console.log('âœ… Project created:', currentProjectId);
                console.log('   Initial tasks:', projectData.tasks.length);
                
                // CRITICAL: Start real-time listener immediately
                listenToProject(currentProjectId);
                console.log('âœ… Real-time listener attached to new project');
                
                showShareModal(currentProjectId);
                
                return currentProjectId;
                
            } catch (error) {
                console.error('âŒ Create error:', error);
                console.error('Failed to create project:', error.message);
                // Don't show alert for brief length issues - project still works locally
                if (!error.message.includes('brief')) {
                    alert('Could not save to cloud. Your project will work locally.');
                }
                return null;
            }
        }
        
        // Load existing project
        async function loadFirebaseProject(projectId) {
            if (!window.firebaseReady || !window.db) {
                console.error('âŒ Firebase not available');
                alert('Cannot load project - Firebase is not available. Please check your internet connection.');
                return false;
            }
            
            try {
                console.log('ðŸ“‚ Loading project:', projectId);
                
                const doc = await window.db.collection('projects').doc(projectId).get();
                
                if (!doc.exists) {
                    console.error('âŒ Project not found');
                    alert('Project not found. The link may be incorrect.');
                    return false;
                }
                
                const data = doc.data();
                
                projectData.members = data.members || [];
                projectData.memberDetails = data.memberDetails || {};
                projectData.startDate = data.startDate ? new Date(data.startDate) : null;
                projectData.endDate = data.endDate ? new Date(data.endDate) : null;
                projectData.brief = data.brief || '';
                projectData.tasks = data.tasks || [];
                projectData.taskNotes = data.taskNotes || {};
                
                currentProjectId = projectId;
                setProjectIdInURL(projectId); // Ensure URL has project ID
                updateProjectIdDisplay(); // Update display immediately
                
                console.log('âœ… Project loaded');
                console.log('   Project ID:', currentProjectId);
                console.log('   Members:', projectData.members.length);
                console.log('   Tasks:', projectData.tasks.length);
                
                // CRITICAL: Always start listener for real-time sync
                listenToProject(projectId);
                console.log('âœ… Real-time listener attached');
                
                // Check if tasks exist
                if (projectData.tasks.length > 0) {
                    // Show welcome modal to prompt user to add their details
                    showTeammateWelcomeModal();
                } else {
                    // No tasks yet - show calendar with empty state
                    renderCalendar();
                    scrollToPage(8);
                    
                    // Show helpful message
                    setTimeout(() => {
                        alert('ðŸ“­ No tasks yet!\n\nThe project host needs to generate the timeline first. You\'ll see tasks appear here once they\'re created.');
                    }, 500);
                }
                
                return true;
                
            } catch (error) {
                console.error('âŒ Load error:', error);
                alert('Failed to load project: ' + error.message);
                return false;
            }
        }
        
        // Show welcome modal for teammates joining via link
        function showTeammateWelcomeModal() {
            const modal = document.createElement('div');
            modal.id = 'teammateWelcomeModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            // Generate member buttons with checkmarks
            const memberButtons = projectData.members.map((member, index) => {
                const hasDetails = projectData.memberDetails[member] && 
                                 (projectData.memberDetails[member].strengths?.length > 0 || 
                                  projectData.memberDetails[member].availability);
                const checkmark = hasDetails ? 'âœ“ ' : '';
                const colorMap = ['#FFB3E6', '#FFE5B3', '#B3D9FF', '#D4B3FF', '#B3FFD9'];
                const accentMap = ['#E91E8C', '#FFB02E', '#2E7DFF', '#8E2EFF', '#2EFF8E'];
                const bgColor = colorMap[index % 5];
                const borderColor = accentMap[index % 5];
                
                return `
                    <button onclick="selectTeammateMember('${member}', ${index})" 
                            style="padding: 1rem 1.5rem; background: ${bgColor}; color: #2F4538; border: 3px solid ${borderColor}; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; min-width: 150px;">
                        ${checkmark}${member}
                    </button>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; padding: 2.5rem; border-radius: 20px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ‘‹</div>
                    <h2 style="font-size: 1.8rem; font-weight: 800; color: #4A6B5A; margin-bottom: 1rem;">Welcome to the Team!</h2>
                    <p style="color: #2F4538; font-size: 1.1rem; margin-bottom: 2rem;">
                        Select your name to continue
                    </p>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-bottom: 1.5rem;">
                        ${memberButtons}
                    </div>
                    
                    <p style="color: #6B7F75; font-size: 0.85rem;">
                        âœ“ = Already added details
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Handle teammate member selection
        window.selectTeammateMember = function(member, memberIndex) {
            const hasDetails = projectData.memberDetails[member] && 
                             (projectData.memberDetails[member].strengths?.length > 0 || 
                              projectData.memberDetails[member].availability);
            
            const modal = document.getElementById('teammateWelcomeModal');
            if (modal) modal.remove();
            
            if (hasDetails) {
                // Already has details - go straight to calendar
                console.log('âœ… User already has details, going to calendar');
                renderCalendar();
                scrollToPage(8);
            } else {
                // No details - show form, then regenerate
                console.log('ðŸ“ User needs to add details');
                showTeammateDetailsForm(member, memberIndex);
            }
        };
        
        // Show details form for teammate
        function showTeammateDetailsForm(member, memberIndex) {
            // Go to team details page
            updateTeamDetailsPage();
            scrollToPage(6);
            
            // Auto-select the member
            setTimeout(() => {
                selectMember(member, memberIndex);
            }, 300);
            
            // Update button to trigger regeneration
            const generateButton = document.getElementById('generateButton');
            const buttonText = document.getElementById('generateButtonText');
            if (buttonText) {
                buttonText.textContent = 'Save & Generate Calendar';
            }
            
            if (generateButton) {
                generateButton.onclick = async function() {
                    console.log('ðŸ’¾ Saving details and regenerating tasks...');
                    
                    // Update Firebase with new member details
                    if (currentProjectId) {
                        await updateFirebaseProject();
                        console.log('âœ… Member details saved to Firebase');
                    }
                    
                    // Show loading page
                    scrollToPage(7);
                    animateProgressBar();
                    
                    try {
                        // Regenerate tasks with updated availability
                        console.log('ðŸ”„ Regenerating tasks with all member details...');
                        const newTasks = await generateTasksFromBrief(
                            'Project',
                            projectData.startDate,
                            projectData.endDate,
                            projectData.brief,
                            projectData.members
                        );
                        
                        projectData.tasks = newTasks;
                        
                        // Update Firebase with new tasks
                        if (currentProjectId) {
                            await updateFirebaseProject();
                            console.log('âœ… Tasks saved to Firebase - all tabs will sync');
                        }
                        
                        // Show calendar
                        setTimeout(() => {
                            renderCalendar();
                            scrollToPage(8);
                        }, 1000);
                        
                    } catch (error) {
                        console.error('âŒ Failed to regenerate:', error);
                        alert('Failed to generate tasks. Please try again.');
                        scrollToPage(6);
                    }
                };
            }
        }
        
        // Legacy function - kept for compatibility
        window.addMyDetails = function() {
            const modal = document.getElementById('teammateWelcomeModal');
            if (modal) modal.remove();
            updateTeamDetailsPage();
            scrollToPage(6);
        };
        
        // Update project in Firebase
        async function updateFirebaseProject() {
            if (!window.firebaseReady || !window.db) {
                console.log('âš ï¸ Firebase not ready, skipping update');
                return false;
            }
            
            if (!currentProjectId) {
                console.log('âš ï¸ No project ID, creating new...');
                return await createFirebaseProject();
            }
            
            try {
                await window.db.collection('projects').doc(currentProjectId).update({
                    members: projectData.members,
                    memberDetails: projectData.memberDetails,
                    startDate: projectData.startDate ? projectData.startDate.toISOString() : null,
                    endDate: projectData.endDate ? projectData.endDate.toISOString() : null,
                    brief: getTruncatedBrief(projectData.brief),
                    tasks: projectData.tasks,
                    taskNotes: projectData.taskNotes || {},
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('âœ… Project updated');
                return true;
                
            } catch (error) {
                console.error('âŒ Update error:', error);
                return false;
            }
        }
        
        // Real-time listener
        function listenToProject(projectId) {
            if (!window.firebaseReady || !window.db) {
                console.error('âŒ Firebase not ready');
                return;
            }
            
            if (unsubscribeListener) {
                unsubscribeListener();
            }
            
            console.log('ðŸ‘‚ Listening for real-time updates on project:', projectId);
            
            unsubscribeListener = window.db.collection('projects').doc(projectId)
                .onSnapshot((doc) => {
                    if (!doc.exists) {
                        console.error('âŒ Project deleted');
                        return;
                    }
                    
                    const data = doc.data();
                    
                    console.log('ðŸ”„ ========================================');
                    console.log('ðŸ”„ REAL-TIME UPDATE RECEIVED FROM FIREBASE');
                    console.log('ðŸ”„ ========================================');
                    console.log('   Project ID:', projectId);
                    console.log('   Tasks count:', data.tasks?.length || 0);
                    console.log('   Members:', data.members?.length || 0);
                    console.log('   Updated at:', data.updatedAt);
                    
                    // Update local data ALWAYS
                    const oldTaskCount = projectData.tasks.length;
                    projectData.members = data.members || [];
                    projectData.memberDetails = data.memberDetails || {};
                    projectData.startDate = data.startDate ? new Date(data.startDate) : null;
                    projectData.endDate = data.endDate ? new Date(data.endDate) : null;
                    projectData.brief = data.brief || '';
                    projectData.tasks = data.tasks || [];
                    projectData.taskNotes = data.taskNotes || {};
                    
                    console.log('âœ… Local data updated from Firebase');
                    console.log('   Old task count:', oldTaskCount);
                    console.log('   New task count:', projectData.tasks.length);
                    
                    // Show sync indicator with task count
                    showSyncIndicator(projectData.tasks.length);
                    
                    // Refresh calendar if on calendar page
                    if (window.currentPage === 8 && typeof renderCalendar === 'function') {
                        console.log('ðŸ“… Refreshing calendar with synced data...');
                        renderCalendar();
                        console.log('âœ… Calendar refreshed');
                    } else {
                        console.log('âš ï¸ Not on calendar page (page ' + window.currentPage + '), skipping render');
                    }
                }, (error) => {
                    console.error('âŒ Listener error:', error);
                    alert('Real-time sync error. Please refresh the page.');
                });
        }
        
        // Show visual sync indicator
        function showSyncIndicator(taskCount) {
            // Create sync indicator if it doesn't exist
            let indicator = document.getElementById('syncIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'syncIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 6rem;
                    right: 2rem;
                    background: #10B981;
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 20px;
                    font-weight: 700;
                    font-size: 0.9rem;
                    z-index: 999;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                indicator.textContent = taskCount ? `âœ“ Synced! ${taskCount} tasks` : 'âœ“ Synced';
                document.body.appendChild(indicator);
            }
            
            // Update text if task count provided
            if (taskCount) {
                indicator.textContent = `âœ“ Synced! ${taskCount} tasks`;
            }
            
            // Show indicator
            indicator.style.opacity = '1';
            
            // Hide after 3 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 3000);
        }
        
        // Show share modal
        function showShareModal(projectId) {
            const shareUrl = window.location.origin + window.location.pathname + '?project=' + projectId;
            
            const modal = document.createElement('div');
            modal.id = 'firebaseShareModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2.5rem; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                    <h2 style="font-size: 1.8rem; font-weight: 800; color: #4A6B5A; margin-bottom: 1rem;">Project Created!</h2>
                    <p style="color: #2F4538; font-size: 1.1rem; margin-bottom: 2rem;">Share this link with your team for real-time collaboration</p>
                    
                    <div style="background: #F5F7F6; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                        <input 
                            id="firebaseShareUrl" 
                            type="text" 
                            readonly 
                            value="${shareUrl}" 
                            style="flex: 1; padding: 0.75rem; border: 2px solid #D4E0D9; border-radius: 8px; font-family: monospace; font-size: 0.85rem; background: white;"
                        >
                        <button onclick="copyFirebaseShareUrl()" style="padding: 0.75rem 1.5rem; background: #4A6B5A; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Copy
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9rem; color: #6B7F75; margin-bottom: 1.5rem;">
                        âœ¨ Changes sync instantly<br>
                        ðŸ‘¥ Everyone with this link can edit
                    </p>
                    
                    <button onclick="closeFirebaseShareModal()" style="width: 100%; padding: 1rem; background: #4A6B5A; color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 1.05rem; cursor: pointer;">
                        Got it!
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        window.copyFirebaseShareUrl = function() {
            const input = document.getElementById('firebaseShareUrl');
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            btn.textContent = 'âœ“ Copied!';
            btn.style.background = '#10B981';
            
            setTimeout(() => {
                btn.textContent = 'Copy';
                btn.style.background = '#4A6B5A';
            }, 2000);
        };
        
        window.closeFirebaseShareModal = function() {
            const modal = document.getElementById('firebaseShareModal');
            if (modal) modal.remove();
        };
        
        console.log('âœ… Firebase initialization starting...');
        
        // ============================================
        // END FIREBASE CODE
        // ============================================
        
        // Define critical functions immediately
        // AI task generation function using our proxy server
        async function generateTasksFromBrief(projectName, startDate, endDate, brief, members) {
            const durationDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            // Build team details string
            let teamDetailsStr = '';
            members.forEach(member => {
                const details = projectData.memberDetails[member];
                if (details) {
                    teamDetailsStr += `\n${member}:`;
                    if (details.strengths && details.strengths.length > 0) {
                        teamDetailsStr += `\n  Strengths: ${details.strengths.join(', ')}`;
                    }
                    if (details.availability) teamDetailsStr += `\n  Busy times: ${details.availability}`;
                }
            });
            
            // Calculate ideal task count: aim for ~5 tasks per week (leaving 2 rest days)
            const weeksInProject = Math.ceil(durationDays / 7);
            const idealTaskCount = Math.max(20, weeksInProject * 5, members.length * 7);
            
            const prompt = `Generate ${idealTaskCount}-${idealTaskCount + 5} project tasks based on the BRIEF REQUIREMENTS.

PROJECT: ${durationDays} days (${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()})
TEAM: ${members.join(', ')}
${teamDetailsStr}

ASSIGNMENT BRIEF (READ CAREFULLY - BASE ALL TASKS ON THIS):
${brief}

TASK COUNT: Generate enough tasks so that most weekdays have at least 1 task. Aim for ~5 task days per week.

âš ï¸ CRITICAL TASK TIMING - MUST FOLLOW:
- FIRST THIRD (Days 1-${Math.floor(durationDays/3)}): Research, planning, gathering materials, initial outlines
- MIDDLE THIRD (Days ${Math.floor(durationDays/3)+1}-${Math.floor(durationDays*2/3)}): Main content creation, drafting, building
- FINAL THIRD (Days ${Math.floor(durationDays*2/3)+1}-${durationDays}): ONLY review, polish, refine, finalize - NO NEW RESEARCH OR DRAFTING

ðŸš« NEVER schedule research, planning, or drafting tasks in the final 7 days!
The final week is ONLY for: Review, Polish, Refine, Proofread, Format, Quality Check, Finalize

TASK NAMING:
- Name tasks based on WHAT THE BRIEF REQUIRES
- Be specific but simple: "Write Introduction Section", "Create Data Chart", "Draft Methodology"
- Final week tasks should be: "Review and Polish Content", "Final Quality Check", "Proofread All Sections", "Format Final Document"

MEETINGS (EXACTLY 3 - NO other tasks on meeting days):
1. "Project Kickoff Meeting" (Everyone) - Day 1 or 2
2. "Mid-Project Review Meeting" (Everyone) - EXACTLY at day ${Math.round(durationDays / 2)} (the true midpoint)
3. "Final Content Review Meeting" (Everyone) - Day ${durationDays - 1} (day before submission)

REST DAYS:
- Weekends (Saturdays/Sundays) can be rest days EXCEPT in final 7 days
- Final 7 days = NO rest days, all work days

DISTRIBUTION BY PHASE:
- Early (Days 1-${Math.floor(durationDays/3)}): Research, planning, gather references, initial drafts
- Middle (Days ${Math.floor(durationDays/3)+1}-${Math.floor(durationDays*2/3)}): Main content creation, writing, building deliverables
- Late (Days ${Math.floor(durationDays*2/3)+1}-${durationDays}): REVIEW AND POLISH ONLY - no new content

FINAL 2 DAYS:
- Second-to-last day: "Final Content Review Meeting" (Everyone) - ONLY THIS TASK
- Last day: "Final Submission" (Everyone) - ONLY THIS TASK

Return ONLY JSON array:
[{"name": "Simple Task Name", "assignee": "Name", "durationDays": 1, "description": "Brief description"}]`;



            try {
                // Use Vercel serverless function for API calls
                const apiEndpoint = '/api/generate';
                
                console.log('ðŸ”— API Endpoint:', apiEndpoint);
                
                // Call our secure API proxy
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                // Anthropic returns: data.content[0].text
                let responseText = data.content?.[0]?.text || '';
                
                console.log('ðŸ“¥ Raw AI Response (first 500 chars):', responseText.substring(0, 500));
                console.log('ðŸ“ Response length:', responseText.length);
                
                // Remove markdown code blocks if present
                responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                console.log('ðŸ§¹ After cleaning:', responseText.substring(0, 200));
                
                // Try multiple methods to extract JSON
                let tasksTemplate = null;
                
                // Method 1: Find JSON array with regex
                let jsonMatch = responseText.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    try {
                        console.log('ðŸ” Method 1: Found JSON with regex');
                        tasksTemplate = JSON.parse(jsonMatch[0]);
                        console.log('âœ… Method 1 SUCCESS: Parsed', tasksTemplate.length, 'tasks');
                    } catch (e) {
                        console.error('âŒ Method 1 FAILED:', e.message);
                    }
                }
                
                // Method 2: Try parsing entire response
                if (!tasksTemplate) {
                    try {
                        console.log('ðŸ” Method 2: Parsing entire response');
                        tasksTemplate = JSON.parse(responseText);
                        console.log('âœ… Method 2 SUCCESS: Parsed', tasksTemplate.length, 'tasks');
                    } catch (e) {
                        console.error('âŒ Method 2 FAILED:', e.message);
                    }
                }
                
                // Method 3: Look for JSON between specific markers
                if (!tasksTemplate) {
                    console.log('ðŸ” Method 3: Extracting between [ and ]');
                    const jsonStart = responseText.indexOf('[');
                    const jsonEnd = responseText.lastIndexOf(']');
                    if (jsonStart !== -1 && jsonEnd !== -1) {
                        try {
                            const jsonStr = responseText.substring(jsonStart, jsonEnd + 1);
                            console.log('   Extracted:', jsonStr.substring(0, 100) + '...');
                            tasksTemplate = JSON.parse(jsonStr);
                            console.log('âœ… Method 3 SUCCESS: Parsed', tasksTemplate.length, 'tasks');
                        } catch (e) {
                            console.error('âŒ Method 3 FAILED:', e.message);
                        }
                    }
                }
                
                if (!tasksTemplate || !Array.isArray(tasksTemplate)) {
                    console.error('âŒ ALL METHODS FAILED');
                    console.error('âŒ Full response:', responseText);
                    throw new Error('AI did not return valid JSON array. Using fallback tasks.');
                }
                
                console.log('âœ… Final tasks count:', tasksTemplate.length);
                console.log('âœ… First task:', tasksTemplate[0]);
                
                // Convert to task objects with dates - IMPROVED DISTRIBUTION WITH REST DAYS
                console.log('ðŸ“… Distributing', tasksTemplate.length, 'tasks across', durationDays, 'days (with rest days)');
                console.log('   Start date:', startDate.toLocaleDateString());
                console.log('   End date:', endDate.toLocaleDateString());
                console.log('   Duration:', durationDays, 'days');
                
                const totalDays = durationDays;
                const tasksCount = tasksTemplate.length;
                
                // Build list of working days (skip weekends for rest)
                const workingDays = [];
                for (let i = 0; i < totalDays; i++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    const dayOfWeek = date.getDay();
                    // Skip Saturdays (6) and Sundays (0) - make them rest days
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        workingDays.push(i);
                    }
                }
                
                console.log(`   Working days: ${workingDays.length} out of ${totalDays} days (Weekends are rest days)`);
                
                // Distribute tasks across working days only
                const tasks = tasksTemplate.map((template, index) => {
                    // Map task index to working day
                    const progressRatio = index / (tasksCount - 1); // 0.0 to 1.0
                    const workingDayIndex = Math.floor(progressRatio * (workingDays.length - 1));
                    const dayOffset = workingDays[workingDayIndex];
                    
                    const dueDate = new Date(startDate);
                    dueDate.setDate(dueDate.getDate() + dayOffset);
                    
                    // Ensure we don't go past end date
                    if (dueDate > endDate) {
                        dueDate.setTime(endDate.getTime());
                    }
                    
                    // Log first, middle, and last few tasks to see distribution
                    if (index < 3 || index > tasksCount - 4 || index === Math.floor(tasksCount / 2)) {
                        console.log(`   Task ${index + 1}/${tasksCount}: "${template.name}" â†’ Working day ${workingDayIndex}, Calendar day ${dayOffset} (${dueDate.toLocaleDateString()})`);
                    }
                    
                    const task = {
                        id: `task_${Date.now()}_${index}`,
                        name: template.name,
                        description: template.description,
                        assignee: template.assignee,
                        dueDate: dueDate.toISOString()
                    };
                    
                    return task;
                });


                // Validate and adjust tasks based on availability
                const validatedTasks = validateTaskAvailability(tasks, startDate, endDate);
                console.log('âœ… Tasks validated and adjusted for availability');
                
                // Balance task distribution
                const balancedTasks = balanceTaskDistribution(validatedTasks);
                console.log('âœ… Tasks balanced across team members');
                
                // Ensure weekly rest days
                const tasksWithRestDays = ensureWeeklyRestDays(balancedTasks, startDate, endDate);
                console.log('âœ… Weekly rest days ensured');
                
                // Clear meeting days of individual tasks
                const cleanedTasks = clearMeetingDays(tasksWithRestDays);
                console.log('âœ… Meeting days cleared of individual tasks');
                
                // Ensure final submission is on last day and review meeting is day before
                const tasksWithFinal = ensureFinalSubmission(cleanedTasks, endDate);
                console.log('âœ… Final submission and review meeting configured');
                
                // Move any research/draft tasks out of final week
                const reorderedTasks = reorderLateResearchTasks(tasksWithFinal, startDate, endDate);
                console.log('âœ… Research tasks moved out of final week');
                
                // Fill any remaining rest days in final week
                const finalTasks = fillFinalWeekRestDays(reorderedTasks, startDate, endDate, members);
                console.log('âœ… Final week rest days filled');
                
                // Limit to max 2 tasks per day
                const limitedTasks = limitTasksPerDay(finalTasks, startDate, endDate);
                console.log('âœ… Tasks limited to max 2 per day');
                
                return limitedTasks;

            } catch (error) {
                console.error('AI Error:', error);
                alert('AI task generation is temporarily unavailable. Using sample tasks instead. Your calendar will still work!');
                // Fallback to sample tasks
                return generateFallbackTasks(startDate, endDate, members);
            }
        }
        
        // Move research/draft/planning tasks out of final week - they should be early
        function reorderLateResearchTasks(tasks, startDate, endDate) {
            console.log('ðŸ”„ Checking for misplaced research tasks in final week...');
            
            // Keywords that indicate early-phase tasks
            const earlyPhaseKeywords = ['research', 'draft', 'plan', 'outline', 'gather', 'collect', 'source', 'initial', 'brainstorm', 'define', 'identify'];
            
            // Keywords that are OK for final week
            const finalWeekKeywords = ['review', 'polish', 'refine', 'finalize', 'proofread', 'format', 'check', 'quality', 'submission', 'meeting'];
            
            // Calculate final week start (last 7 days)
            const finalWeekStart = new Date(endDate);
            finalWeekStart.setDate(finalWeekStart.getDate() - 6);
            finalWeekStart.setHours(0, 0, 0, 0);
            
            // Find tasks that are in final week but shouldn't be
            const misplacedTasks = [];
            tasks.forEach(task => {
                const taskDate = new Date(task.dueDate);
                if (taskDate >= finalWeekStart) {
                    const taskNameLower = task.name.toLowerCase();
                    
                    // Check if it's an early-phase task
                    const isEarlyPhase = earlyPhaseKeywords.some(kw => taskNameLower.includes(kw));
                    const isFinalPhase = finalWeekKeywords.some(kw => taskNameLower.includes(kw));
                    
                    if (isEarlyPhase && !isFinalPhase && task.assignee !== 'Everyone') {
                        misplacedTasks.push(task);
                    }
                }
            });
            
            if (misplacedTasks.length === 0) {
                console.log('   No misplaced tasks found');
                return tasks;
            }
            
            console.log(`   Found ${misplacedTasks.length} misplaced tasks, moving earlier...`);
            
            // Move each misplaced task to an earlier date
            misplacedTasks.forEach(task => {
                // Find a date in the first half of the project
                const midPoint = new Date(startDate);
                midPoint.setDate(midPoint.getDate() + Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24) / 3));
                
                // Find a day with fewer tasks
                let bestDate = new Date(startDate);
                bestDate.setDate(bestDate.getDate() + 2); // Start from day 3
                
                let minTasks = Infinity;
                const checkDate = new Date(startDate);
                checkDate.setDate(checkDate.getDate() + 2);
                
                while (checkDate <= midPoint) {
                    const dayOfWeek = checkDate.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Skip weekends
                        const dateStr = checkDate.toDateString();
                        const tasksOnDay = tasks.filter(t => new Date(t.dueDate).toDateString() === dateStr).length;
                        
                        if (tasksOnDay < minTasks) {
                            minTasks = tasksOnDay;
                            bestDate = new Date(checkDate);
                        }
                    }
                    checkDate.setDate(checkDate.getDate() + 1);
                }
                
                console.log(`   Moving "${task.name}" from ${new Date(task.dueDate).toLocaleDateString()} to ${bestDate.toLocaleDateString()}`);
                task.dueDate = bestDate.toISOString();
                
                // Rename to a review task for the final week slot
                // (fillFinalWeekRestDays will fill the gap with appropriate tasks)
            });
            
            return tasks;
        }
        
        // Balance tasks equally across team members
        function balanceTaskDistribution(tasks) {
            console.log('âš–ï¸ Balancing task distribution...');
            
            // Count tasks per member (excluding "Everyone")
            const taskCounts = {};
            projectData.members.forEach(member => {
                taskCounts[member] = 0;
            });
            
            tasks.forEach(task => {
                if (task.assignee !== 'Everyone' && taskCounts.hasOwnProperty(task.assignee)) {
                    taskCounts[task.assignee]++;
                }
            });
            
            console.log('Current distribution:', taskCounts);
            
            // Find min and max
            const counts = Object.values(taskCounts);
            const minTasks = Math.min(...counts);
            const maxTasks = Math.max(...counts);
            const avgTasks = Math.round(counts.reduce((a, b) => a + b, 0) / counts.length);
            
            console.log(`   Min: ${minTasks}, Max: ${maxTasks}, Avg: ${avgTasks}`);
            
            // If difference is too large, redistribute
            if (maxTasks - minTasks > 2) {
                console.log('âš ï¸ Unbalanced! Redistributing tasks...');
                
                // Find members who have too many tasks
                const overloaded = Object.entries(taskCounts)
                    .filter(([_, count]) => count > avgTasks + 1)
                    .map(([member, _]) => member);
                
                // Find members who have too few tasks
                const underloaded = Object.entries(taskCounts)
                    .filter(([_, count]) => count < avgTasks - 1)
                    .map(([member, _]) => member);
                
                console.log('   Overloaded:', overloaded);
                console.log('   Underloaded:', underloaded);
                
                // Reassign tasks from overloaded to underloaded
                overloaded.forEach(overloadedMember => {
                    const memberTasks = tasks.filter(t => t.assignee === overloadedMember);
                    const tasksToReassign = Math.floor((taskCounts[overloadedMember] - avgTasks) / 2);
                    
                    for (let i = 0; i < tasksToReassign && underloaded.length > 0; i++) {
                        const taskIndex = tasks.findIndex(t => t.assignee === overloadedMember);
                        if (taskIndex !== -1) {
                            const newAssignee = underloaded[i % underloaded.length];
                            tasks[taskIndex].assignee = newAssignee;
                            taskCounts[overloadedMember]--;
                            taskCounts[newAssignee]++;
                            console.log(`   âœ“ Reassigned "${tasks[taskIndex].name}" from ${overloadedMember} to ${newAssignee}`);
                        }
                    }
                });
                
                console.log('âœ… Rebalanced distribution:', taskCounts);
            } else {
                console.log('âœ… Distribution already balanced');
            }
            
            return tasks;
        }
        
        // Ensure rest days are ONLY on weekends (Sat/Sun), NEVER on weekdays
        // Final week = 0 rest days, all other weeks = 2 rest days (Sat & Sun only)
        function ensureWeeklyRestDays(tasks, startDate, endDate) {
            console.log('ðŸ›Œ Ensuring rest days: Sat/Sun only (not in last 7 days), weekdays MUST have tasks...');
            
            // Last 7 days = no rest days allowed
            const last7DaysStart = new Date(endDate);
            last7DaysStart.setDate(endDate.getDate() - 6);
            last7DaysStart.setHours(0, 0, 0, 0);
            
            console.log(`   Last 7 days starts: ${last7DaysStart.toLocaleDateString()}`);
            
            // First pass: Move weekend tasks to Friday (NOT in last 7 days)
            let currentDate = new Date(startDate);
            currentDate.setHours(0, 0, 0, 0);
            
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isInLast7Days = currentDate >= last7DaysStart;
                const dateStr = currentDate.toDateString();
                
                if (isWeekend && !isInLast7Days) {
                    const tasksOnDay = tasks.filter(t => new Date(t.dueDate).toDateString() === dateStr);
                    if (tasksOnDay.length > 0) {
                        console.log(`   ðŸ›Œ ${dateStr} is weekend - moving tasks to Friday`);
                        tasksOnDay.forEach(task => {
                            if (!task.name.toLowerCase().includes('meeting') && task.assignee !== 'Everyone') {
                                const friday = new Date(currentDate);
                                friday.setDate(friday.getDate() - (dayOfWeek === 0 ? 2 : 1));
                                task.dueDate = friday.toISOString();
                                console.log(`      Moved "${task.name}" to Friday`);
                            }
                        });
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Second pass: Fill empty WEEKDAYS with tasks (weekdays should NEVER be rest days)
            currentDate = new Date(startDate);
            currentDate.setHours(0, 0, 0, 0);
            
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5; // Mon-Fri
                const dateStr = currentDate.toDateString();
                
                if (isWeekday) {
                    const tasksOnDay = tasks.filter(t => new Date(t.dueDate).toDateString() === dateStr);
                    
                    if (tasksOnDay.length === 0) {
                        console.log(`   âš ï¸ ${dateStr} is empty weekday - finding task to move here`);
                        
                        // Find a task from a busy day (2+ tasks) to move here
                        let moved = false;
                        for (const task of tasks) {
                            if (moved) break;
                            const taskDate = new Date(task.dueDate);
                            const taskDateStr = taskDate.toDateString();
                            
                            // Count tasks on that day
                            const tasksOnSourceDay = tasks.filter(t => 
                                new Date(t.dueDate).toDateString() === taskDateStr
                            );
                            
                            if (tasksOnSourceDay.length >= 2 &&
                                !task.name.toLowerCase().includes('meeting') &&
                                !task.name.toLowerCase().includes('final submission') &&
                                task.assignee !== 'Everyone') {
                                task.dueDate = new Date(currentDate).toISOString();
                                console.log(`      Moved "${task.name}" here`);
                                moved = true;
                            }
                        }
                        
                        // If no task could be moved, create a placeholder
                        if (!moved) {
                            const members = projectData.members || ['Team'];
                            const newTask = {
                                id: `task_fill_${Date.now()}_${currentDate.getDate()}`,
                                name: 'Review Progress and Plan Ahead',
                                description: 'Check project progress and prepare for upcoming tasks',
                                assignee: members[Math.floor(Math.random() * members.length)] || 'Everyone',
                                dueDate: new Date(currentDate).toISOString(),
                                completed: false
                            };
                            tasks.push(newTask);
                            console.log(`      Created placeholder task`);
                        }
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return tasks;
        }
        
        // Fill ALL rest days in the LAST 7 DAYS - NO REST DAYS ALLOWED
        function fillFinalWeekRestDays(tasks, startDate, endDate, members) {
            console.log('ðŸ GUARANTEEING no rest days in last 7 days...');
            
            // Last 7 days = endDate minus 6 days
            const last7DaysStart = new Date(endDate);
            last7DaysStart.setDate(endDate.getDate() - 6);
            last7DaysStart.setHours(0, 0, 0, 0);
            
            console.log(`   Last 7 days: ${last7DaysStart.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
            
            // Get list of members
            const memberList = members || projectData.members || ['Team'];
            
            // Review task names for variety
            const reviewTaskNames = [
                'Review and Polish Content',
                'Final Quality Check',
                'Proofread All Sections',
                'Check Formatting Consistency',
                'Verify All Requirements Met',
                'Final Content Review',
                'Polish Visual Elements'
            ];
            
            let taskNameIndex = 0;
            
            // Check EVERY day in last 7 days
            const currentDate = new Date(last7DaysStart);
            while (currentDate <= endDate) {
                const dateStr = currentDate.toDateString();
                
                // Only process if this date is within the project range
                if (currentDate >= startDate) {
                    // Count tasks on this day
                    const tasksOnDay = tasks.filter(task => 
                        new Date(task.dueDate).toDateString() === dateStr
                    );
                    
                    console.log(`   ${dateStr}: ${tasksOnDay.length} tasks`);
                    
                    // If NO tasks on this day, CREATE one
                    if (tasksOnDay.length === 0) {
                        const assignee = memberList[taskNameIndex % memberList.length] || 'Everyone';
                        const taskName = reviewTaskNames[taskNameIndex % reviewTaskNames.length];
                        
                        const newTask = {
                            id: `task_finalweek_${Date.now()}_${currentDate.getDate()}`,
                            name: taskName,
                            description: 'Final week task - ensure project completion',
                            assignee: assignee,
                            dueDate: new Date(currentDate).toISOString(),
                            completed: false
                        };
                        tasks.push(newTask);
                        console.log(`   âœ… CREATED "${taskName}" for ${dateStr} (${assignee})`);
                        taskNameIndex++;
                    }
                }
                
                // Move to next day
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('ðŸ Last 7 days complete - all days have tasks');
            return tasks;
        }
        
        // Limit max 2 tasks per day - redistribute excess to nearby days
        function limitTasksPerDay(tasks, startDate, endDate) {
            console.log('ðŸ“Š Limiting to max 2 tasks per day...');
            
            const MAX_TASKS_PER_DAY = 2;
            
            // Group tasks by date
            const tasksByDate = new Map();
            tasks.forEach(task => {
                const dateStr = new Date(task.dueDate).toDateString();
                if (!tasksByDate.has(dateStr)) {
                    tasksByDate.set(dateStr, []);
                }
                tasksByDate.get(dateStr).push(task);
            });
            
            // Find days with too many tasks
            for (const [dateStr, dayTasks] of tasksByDate) {
                if (dayTasks.length > MAX_TASKS_PER_DAY) {
                    console.log(`   âš ï¸ ${dateStr} has ${dayTasks.length} tasks - redistributing...`);
                    
                    // Sort: keep meetings and "Everyone" tasks, move individual tasks
                    const keepTasks = dayTasks.filter(t => 
                        t.name.toLowerCase().includes('meeting') || 
                        t.name.toLowerCase().includes('final submission') ||
                        t.assignee === 'Everyone'
                    );
                    const movableTasks = dayTasks.filter(t => 
                        !t.name.toLowerCase().includes('meeting') && 
                        !t.name.toLowerCase().includes('final submission') &&
                        t.assignee !== 'Everyone'
                    );
                    
                    // Keep up to MAX, move the rest
                    const tasksToKeep = [...keepTasks, ...movableTasks.slice(0, MAX_TASKS_PER_DAY - keepTasks.length)];
                    const tasksToMove = movableTasks.slice(MAX_TASKS_PER_DAY - keepTasks.length);
                    
                    // Move excess tasks to adjacent days with fewer tasks
                    const currentDate = new Date(dateStr);
                    for (const task of tasksToMove) {
                        // Try previous day first, then next day
                        for (let offset of [-1, 1, -2, 2]) {
                            const newDate = new Date(currentDate);
                            newDate.setDate(newDate.getDate() + offset);
                            
                            // Check bounds
                            if (newDate < startDate || newDate > endDate) continue;
                            
                            const newDateStr = newDate.toDateString();
                            const newDayTasks = tasksByDate.get(newDateStr) || [];
                            
                            if (newDayTasks.length < MAX_TASKS_PER_DAY) {
                                task.dueDate = newDate.toISOString();
                                if (!tasksByDate.has(newDateStr)) {
                                    tasksByDate.set(newDateStr, []);
                                }
                                tasksByDate.get(newDateStr).push(task);
                                console.log(`      Moved "${task.name}" to ${newDateStr}`);
                                break;
                            }
                        }
                    }
                }
            }
            
            return tasks;
        }
        
        // Clear meeting days of individual tasks - meeting days should ONLY have the meeting
        function clearMeetingDays(tasks) {
            console.log('ðŸ§¹ Clearing meeting days of individual tasks...');
            
            // Find all meeting tasks
            const meetingTasks = tasks.filter(task => 
                task.name.toLowerCase().includes('meeting') &&
                task.assignee === 'Everyone'
            );
            
            console.log('   Found', meetingTasks.length, 'meetings');
            
            // Get dates of meeting days
            const meetingDates = meetingTasks.map(task => 
                new Date(task.dueDate).toDateString()
            );
            
            console.log('   Meeting dates:', meetingDates);
            
            // Remove any non-meeting tasks from meeting days
            const cleanedTasks = tasks.filter(task => {
                const taskDate = new Date(task.dueDate).toDateString();
                const isOnMeetingDay = meetingDates.includes(taskDate);
                const isMeetingTask = task.name.toLowerCase().includes('meeting') || 
                                      task.assignee === 'Everyone';
                
                // Keep if: not on a meeting day, OR if it's the meeting itself
                if (isOnMeetingDay && !isMeetingTask) {
                    console.log('   âŒ Removing individual task from meeting day:', task.name);
                    return false;
                }
                return true;
            });
            
            console.log('   Tasks after cleaning:', cleanedTasks.length);
            return cleanedTasks;
        }
        
        // Ensure final submission task is on last day AND final content review is day before
        function ensureFinalSubmission(tasks, endDate) {
            console.log('ðŸ“… Ensuring final submission and review meeting...');
            console.log('   End date:', endDate.toLocaleDateString());
            
            // Calculate day before submission
            const dayBeforeSubmission = new Date(endDate);
            dayBeforeSubmission.setDate(dayBeforeSubmission.getDate() - 1);
            console.log('   Day before submission:', dayBeforeSubmission.toLocaleDateString());
            
            // 1. Handle Final Submission
            let finalSubmission = tasks.find(task => 
                task.name.toLowerCase() === 'final submission'
            );
            
            if (finalSubmission) {
                finalSubmission.dueDate = endDate.toISOString();
                finalSubmission.assignee = 'Everyone';
            } else {
                finalSubmission = {
                    id: `task_final_${Date.now()}`,
                    name: 'Final Submission',
                    description: 'Submit completed project',
                    assignee: 'Everyone',
                    dueDate: endDate.toISOString(),
                    completed: false
                };
                tasks.push(finalSubmission);
                console.log('   âž• Added Final Submission task');
            }
            
            // 2. Handle Final Content Review Meeting - must be day BEFORE submission
            let reviewMeeting = tasks.find(task => 
                task.name.toLowerCase().includes('final content review') ||
                task.name.toLowerCase().includes('final review meeting')
            );
            
            if (reviewMeeting) {
                reviewMeeting.dueDate = dayBeforeSubmission.toISOString();
                reviewMeeting.assignee = 'Everyone';
                console.log('   âœ… Moved Final Content Review Meeting to', dayBeforeSubmission.toLocaleDateString());
            } else {
                reviewMeeting = {
                    id: `task_review_${Date.now()}`,
                    name: 'Final Content Review Meeting',
                    description: 'Final team review before submission',
                    assignee: 'Everyone',
                    dueDate: dayBeforeSubmission.toISOString(),
                    completed: false
                };
                tasks.push(reviewMeeting);
                console.log('   âž• Added Final Content Review Meeting');
            }
            
            // 3. Remove any other tasks on submission day (only Final Submission should be there)
            tasks = tasks.filter(task => {
                const taskDate = new Date(task.dueDate).toDateString();
                const isOnSubmissionDay = taskDate === endDate.toDateString();
                const isFinalSubmission = task.name.toLowerCase() === 'final submission';
                
                if (isOnSubmissionDay && !isFinalSubmission) {
                    // Move this task to an earlier day
                    const newDate = new Date(endDate);
                    newDate.setDate(newDate.getDate() - 2); // Move to 2 days before
                    task.dueDate = newDate.toISOString();
                    console.log(`   ðŸ“¦ Moved "${task.name}" from submission day to ${newDate.toLocaleDateString()}`);
                }
                return true;
            });
            
            // 4. Remove any other tasks on review meeting day
            tasks = tasks.filter(task => {
                const taskDate = new Date(task.dueDate).toDateString();
                const isOnReviewDay = taskDate === dayBeforeSubmission.toDateString();
                const isReviewMeeting = task.name.toLowerCase().includes('final content review') || 
                                        task.name.toLowerCase().includes('final review meeting');
                
                if (isOnReviewDay && !isReviewMeeting) {
                    // Move this task to an earlier day
                    const newDate = new Date(dayBeforeSubmission);
                    newDate.setDate(newDate.getDate() - 1); // Move to day before review
                    task.dueDate = newDate.toISOString();
                    console.log(`   ðŸ“¦ Moved "${task.name}" from review day to ${newDate.toLocaleDateString()}`);
                }
                return true;
            });
            
            console.log('   âœ… Final 2 days configured correctly');
            return tasks;
        }
        
        // Validate tasks respect availability constraints
        function validateTaskAvailability(tasks, startDate, endDate) {
            console.log('ðŸ” Validating task availability...');
            
            // Parse availability constraints for each member
            const memberConstraints = {};
            Object.keys(projectData.memberDetails).forEach(member => {
                const availability = projectData.memberDetails[member]?.availability;
                if (availability) {
                    memberConstraints[member] = parseAvailability(availability);
                }
            });
            
            // Check each task
            const adjustedTasks = tasks.map(task => {
                if (task.assignee === 'Everyone') return task; // Group tasks always OK
                
                const constraints = memberConstraints[task.assignee];
                if (!constraints || constraints.length === 0) return task; // No constraints
                
                const taskDate = new Date(task.dueDate);
                const dayOfWeek = taskDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[dayOfWeek];
                
                // Check if task violates any constraint
                let violatesConstraint = false;
                constraints.forEach(constraint => {
                    if (constraint.days.includes(dayName) || 
                        constraint.days.includes(dayName.substring(0, 3)) || // Mon, Tue, etc.
                        (constraint.isWeekend && (dayOfWeek === 0 || dayOfWeek === 6))) {
                        violatesConstraint = true;
                        console.log(`âš ï¸ Task "${task.name}" for ${task.assignee} on ${dayName} violates constraint`);
                    }
                });
                
                // If violation, try to move task to next available day
                if (violatesConstraint) {
                    let newDate = new Date(taskDate);
                    let attempts = 0;
                    while (attempts < 7) { // Try up to 7 days ahead
                        newDate.setDate(newDate.getDate() + 1);
                        if (newDate > endDate) break; // Don't go past project end
                        
                        const newDay = newDate.getDay();
                        const newDayName = dayNames[newDay];
                        let isAvailable = true;
                        
                        constraints.forEach(constraint => {
                            if (constraint.days.includes(newDayName) || 
                                constraint.days.includes(newDayName.substring(0, 3)) ||
                                (constraint.isWeekend && (newDay === 0 || newDay === 6))) {
                                isAvailable = false;
                            }
                        });
                        
                        if (isAvailable) {
                            console.log(`âœ… Moved task "${task.name}" from ${dayName} to ${newDayName}`);
                            task.dueDate = newDate.toISOString();
                            return task;
                        }
                        
                        attempts++;
                    }
                }
                
                return task;
            });
            
            return adjustedTasks;
        }
        
        // Parse availability text into structured constraints
        function parseAvailability(availabilityText) {
            if (!availabilityText) return [];
            
            const text = availabilityText.toLowerCase();
            const constraints = [];
            
            // Common patterns
            const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday', 
                             'mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            // Check for each day mentioned
            dayNames.forEach(day => {
                if (text.includes(day)) {
                    // Look for ranges like "mon-wed"
                    const rangeMatch = text.match(new RegExp(`(mon|tue|wed|thu|fri|sat|sun)[-â€“](mon|tue|wed|thu|fri|sat|sun)`, 'i'));
                    if (rangeMatch) {
                        const dayMap = {mon:1, tue:2, wed:3, thu:4, fri:5, sat:6, sun:0};
                        const start = dayMap[rangeMatch[1].toLowerCase()];
                        const end = dayMap[rangeMatch[2].toLowerCase()];
                        const rangeDays = [];
                        for (let i = start; i <= end; i++) {
                            rangeDays.push(['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][i]);
                        }
                        constraints.push({ days: rangeDays, text: availabilityText });
                    } else {
                        // Single day mention
                        const fullDay = {
                            mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', 
                            thu: 'Thursday', fri: 'Friday', sat: 'Saturday', sun: 'Sunday',
                            monday: 'Monday', tuesday: 'Tuesday', wednesday: 'Wednesday',
                            thursday: 'Thursday', friday: 'Friday', saturday: 'Saturday', sunday: 'Sunday'
                        }[day];
                        if (fullDay) {
                            constraints.push({ days: [fullDay], text: availabilityText });
                        }
                    }
                }
            });
            
            // Check for "weekend" mention
            if (text.includes('weekend')) {
                constraints.push({ days: ['Saturday', 'Sunday'], isWeekend: true, text: availabilityText });
            }
            
            // Check for "weekday" mention (reverse - they're busy on weekdays)
            if (text.includes('weekday')) {
                constraints.push({ days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'], text: availabilityText });
            }
            
            return constraints;
        }

        // Fallback if AI fails
        function generateFallbackTasks(startDate, endDate, members) {
            const taskTemplates = [
                { name: 'Research & Planning', days: 7 },
                { name: 'Data Collection', days: 5 },
                { name: 'Analysis', days: 7 },
                { name: 'Draft Report', days: 5 },
                { name: 'Final Review', days: 3 }
            ];

            let currentDate = new Date(startDate);
            return taskTemplates.map((template, index) => {
                const dueDate = new Date(currentDate);
                dueDate.setDate(dueDate.getDate() + template.days);
                
                if (dueDate > endDate) {
                    dueDate.setTime(endDate.getTime());
                }

                const task = {
                    id: `task_${index}`,
                    name: template.name,
                    assignee: members[index % members.length],
                    dueDate: dueDate.toISOString()
                };

                currentDate = new Date(dueDate);
                return task;
            });
        }

        // State
        let currentPage = 1;
        window.currentPage = 1; // Make it globally accessible
        let projectData = {
            members: [],
            memberDetails: {}, // NEW: Store strengths and availability for each member
            startDate: null,
            endDate: null,
            brief: '',
            tasks: [],
            taskNotes: {} // Store notes for each task: { taskId: "note text" }
        };

        // Helper: Truncate brief for Firebase (max ~500KB to be safe)
        function getTruncatedBrief(brief) {
            const MAX_BRIEF_LENGTH = 500000; // 500KB max
            if (brief && brief.length > MAX_BRIEF_LENGTH) {
                console.log(`âš ï¸ Brief truncated from ${brief.length} to ${MAX_BRIEF_LENGTH} chars for storage`);
                return brief.substring(0, MAX_BRIEF_LENGTH) + '... [truncated for storage]';
            }
            return brief || '';
        }

        // Scroll to page function
        window.scrollToPage = function(pageNum) {
            // Lock: Prevent going back once calendar is generated (page 8)
            if (currentPage === 8 && pageNum < 8) {
                console.log('ðŸ”’ Calendar locked - cannot go back');
                return;
            }
            
            // Lock: Prevent going back from review page (page 9) EXCEPT to calendar (page 8)
            if (currentPage === 9 && pageNum < 8) {
                console.log('ðŸ”’ Review page locked - cannot go back');
                return;
            }
            
            // Validate before moving forward
            if (pageNum === 3 && projectData.members.length === 0) {
                alert('Add at least one team member!');
                return;
            }
            if (pageNum === 4 && !document.getElementById('startDate').value) {
                alert('Pick a start date!');
                return;
            }
            if (pageNum === 5 && !document.getElementById('endDate').value) {
                alert('Pick an end date!');
                return;
            }
            if (pageNum === 6 && projectData.members.length === 0) {
                alert('Add at least one team member!');
                return;
            }
            
            // Populate team details page when navigating to it (page 6 now)
            if (pageNum === 6) {
                console.log('ðŸ“‹ Populating team details page for:', projectData.members);
                updateTeamDetailsPage();
            }

            // Smooth fade + slide transition
            const currentPageEl = document.getElementById(`page${currentPage}`);
            const nextPageEl = document.getElementById(`page${pageNum}`);
            
            if (!nextPageEl) return;
            
            // Determine direction (forward or backward)
            const isForward = pageNum > currentPage;
            
            // Slide out current page
            if (currentPageEl) {
                currentPageEl.classList.remove('active');
                currentPageEl.style.transform = isForward ? 'translateY(-30px)' : 'translateY(30px)';
                currentPageEl.style.opacity = '0';
            }
            
            setTimeout(() => {
                if (currentPageEl) currentPageEl.classList.add('hidden');
                
                // Prepare next page
                nextPageEl.style.transform = isForward ? 'translateY(30px)' : 'translateY(-30px)';
                nextPageEl.style.opacity = '0';
                nextPageEl.classList.remove('hidden');
                
                // Trigger slide in
                setTimeout(() => {
                    nextPageEl.classList.add('active');
                    nextPageEl.style.transform = 'translateY(0)';
                    nextPageEl.style.opacity = '1';
                }, 50);
                
                currentPage = pageNum;
                window.currentPage = pageNum; // Keep window.currentPage in sync
                updateProgress();
                
                // Lock navigation when reaching calendar page
                if (pageNum === 8) {
                    const logoContainer = document.getElementById('logoContainer');
                    if (logoContainer) {
                        logoContainer.classList.add('calendar-locked');
                    }
                    console.log('ðŸ”’ Calendar locked - navigation disabled');
                }
            }, 400);
        };

        // Update progress indicator
        function updateProgress() {
            const indicator = document.getElementById('progressIndicator');
            const chatbotButton = document.getElementById('chatbotButton');
            
            // Show chatbot only on calendar page (page 8)
            if (currentPage === 8) {
                if (indicator) indicator.style.display = 'none';
                if (chatbotButton) chatbotButton.style.display = 'flex';
                toggleProgressCircle();
            } else if (currentPage === 1 || currentPage > 6) {
                if (indicator) indicator.style.display = 'none';
                if (chatbotButton) chatbotButton.style.display = 'none';
                toggleProgressCircle();
            } else {
                if (indicator) {
                    indicator.style.display = 'block';
                    indicator.textContent = `${currentPage - 1}/5`;
                }
                if (chatbotButton) chatbotButton.style.display = 'none';
                toggleProgressCircle();
            }
        }

        // Add team member
        window.addTeamMember = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('teamInput');
                let name = input.value.trim();
                
                // Auto-capitalize first letter of each word
                name = name.split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                ).join(' ');
                
                if (name && !projectData.members.includes(name)) {
                    projectData.members.push(name);
                    projectData.memberDetails[name] = { strengths: [], availability: '' };
                    updateTeamDisplay();
                    updateTeamDetailsPage();
                    input.value = '';
                }
            }
        };

        function updateTeamDisplay() {
            const container = document.getElementById('teamMembers');
            container.innerHTML = projectData.members.map((member, index) => `
                <div class="member-bubble">
                    ${member}
                    <span class="remove-member" onclick="removeMember(${index})">Ã—</span>
                </div>
            `).join('');
        }

        // NEW: Populate team details page
        function updateTeamDetailsPage() {
            console.log('ðŸ”§ updateTeamDetailsPage called');
            const selector = document.getElementById('teamMemberSelector');
            const detailsDiv = document.getElementById('selectedMemberDetails');
            
            if (!selector) {
                console.error('âŒ teamMemberSelector not found!');
                return;
            }
            console.log('âœ… Selector found, populating for', projectData.members.length, 'members');
            
            // Color map that matches calendar
            const getColorForMember = (index) => {
                const colorMap = [
                    { bg: '#FFB3E6', border: '#E91E8C', text: '#2F4538' }, // Pink
                    { bg: '#FFE5B3', border: '#FFB02E', text: '#2F4538' }, // Orange
                    { bg: '#B3D9FF', border: '#2E7DFF', text: '#2F4538' }, // Blue
                    { bg: '#D4B3FF', border: '#8E2EFF', text: '#2F4538' }, // Purple
                    { bg: '#B3FFD9', border: '#2EFF8E', text: '#2F4538' }  // Green
                ];
                return colorMap[index % 5];
            };
            
            // Create clickable member buttons with calendar colors
            selector.innerHTML = projectData.members.map((member, index) => {
                const hasData = projectData.memberDetails[member]?.strengths?.length > 0 || 
                               projectData.memberDetails[member]?.availability;
                const checkmark = hasData ? ' âœ“' : '';
                const colors = getColorForMember(index);
                
                return `
                    <button 
                        onclick="selectMember('${member}', ${index})" 
                        class="member-bubble"
                        data-member-index="${index}"
                        style="font-size: 1.1rem; padding: 0.75rem 1.5rem; cursor: pointer; background: ${colors.bg}; color: ${colors.text}; border: 3px solid ${colors.border}; transition: all 0.3s;"
                    >
                        ${member}${checkmark}
                    </button>
                `;
            }).join('');
        }
        
        // NEW: Select a member to fill in their details
        window.selectMember = function(member, memberIndex) {
            console.log('Selected member:', member, 'index:', memberIndex);
            const detailsDiv = document.getElementById('selectedMemberDetails');
            const selector = document.getElementById('teamMemberSelector');
            
            // Color map
            const colorMap = [
                { bg: '#FFB3E6', border: '#E91E8C', text: '#2F4538' },
                { bg: '#FFE5B3', border: '#FFB02E', text: '#2F4538' },
                { bg: '#B3D9FF', border: '#2E7DFF', text: '#2F4538' },
                { bg: '#D4B3FF', border: '#8E2EFF', text: '#2F4538' },
                { bg: '#B3FFD9', border: '#2EFF8E', text: '#2F4538' }
            ];
            
            const memberColor = colorMap[memberIndex % 5];
            
            // Highlight selected member
            const buttons = selector.querySelectorAll('button');
            buttons.forEach((btn, idx) => {
                const btnColor = colorMap[idx % 5];
                if (btn.textContent.includes(member)) {
                    btn.style.background = memberColor.bg;
                    btn.style.borderColor = memberColor.border;
                    btn.style.borderWidth = '4px';
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = `0 4px 12px ${memberColor.border}60`;
                } else {
                    btn.style.background = btnColor.bg;
                    btn.style.borderColor = btnColor.border;
                    btn.style.borderWidth = '3px';
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = 'none';
                }
            });
            
            const skillOptions = [
                'Research & Analysis',
                'Writing & Editing',
                'Excel & Data',
                'Presentation Skills',
                'Coding & Programming',
                'Design & Creative',
                'Public Speaking',
                'Project Management',
                'Critical Thinking',
                'Time Management',
                'Teamwork & Collaboration',
                'Problem Solving',
                'Attention to Detail',
                'Communication'
            ];
            
            const memberSkills = projectData.memberDetails[member]?.strengths || [];
            
            detailsDiv.style.display = 'block';
            detailsDiv.innerHTML = `
                <div style="background: ${memberColor.bg}40; padding: 1rem; border-radius: 12px; border: 3px solid ${memberColor.border};">
                    <h3 style="font-size: 1.1rem; font-weight: 900; color: ${memberColor.text}; margin-bottom: 0.75rem; text-align: center;">${member}</h3>
                    
                    <label style="display: block; font-weight: 600; color: var(--text); margin-bottom: 0.4rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.4rem;">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" style="flex-shrink: 0;">
                            <rect x="2" y="3" width="12" height="11" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M2 6H14M5 1V4M11 1V4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        Your Busy Times & Commitments:
                    </label>
                    <textarea 
                        id="availability-individual"
                        placeholder="Mention specific days e.g. Work Mon/Wed 9-5, Gym Tue/Thu 6-8pm"
                        style="width: 100%; min-height: 70px; padding: 0.6rem; border-radius: 8px; border: 2px solid ${memberColor.border}; font-family: inherit; font-size: 0.9rem; background: white; color: var(--text); resize: none;"
                        oninput="saveTeamDetail('${member}', 'availability', this.value);"
                    >${projectData.memberDetails[member]?.availability || ''}</textarea>
                </div>
            `;
            
            // Prevent ALL scrolling on this section
            setTimeout(() => {
                detailsDiv.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                }, { passive: false });
                
                detailsDiv.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }, 100);
        };

        // NEW: Save team member details
        window.saveTeamDetail = function(member, field, value) {
            if (!projectData.memberDetails[member]) {
                projectData.memberDetails[member] = { strengths: [], availability: '' };
            }
            projectData.memberDetails[member][field] = value;
        };
        
        // NEW: Add skill to member
        window.addSkill = function(member, skill) {
            if (!projectData.memberDetails[member].strengths) {
                projectData.memberDetails[member].strengths = [];
            }
            if (!projectData.memberDetails[member].strengths.includes(skill)) {
                projectData.memberDetails[member].strengths.push(skill);
                updateTeamDetailsPage();
            }
        };
        
        // NEW: Remove skill from member
        window.removeSkill = function(member, skill) {
            if (!projectData.memberDetails[member].strengths) return;
            projectData.memberDetails[member].strengths = projectData.memberDetails[member].strengths.filter(s => s !== skill);
            updateTeamDetailsPage();
        };

        window.removeMember = function(index) {
            const member = projectData.members[index];
            delete projectData.memberDetails[member];
            projectData.members.splice(index, 1);
            updateTeamDisplay();
            updateTeamDetailsPage();
        };
        
        // Referral popup functions
        window.showReferralPopup = function() {
            const popup = document.getElementById('referralPopup');
            const shareLink = document.getElementById('shareLink');
            
            // Save project data to localStorage so teammates can access it
            const projectId = 'talli_project_' + Date.now();
            localStorage.setItem('currentProjectId', projectId);
            localStorage.setItem(projectId, JSON.stringify({
                members: projectData.members,
                memberDetails: projectData.memberDetails,
                startDate: projectData.startDate.toISOString(),
                endDate: projectData.endDate.toISOString(),
                brief: getTruncatedBrief(projectData.brief),
                tasks: projectData.tasks,
                taskNotes: projectData.taskNotes
            }));
            
            // Generate shareable link with project ID
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?join=${projectId}`;
            shareLink.value = shareUrl;
            
            popup.style.display = 'flex';
        };
        
        window.closeReferralPopup = function() {
            const popup = document.getElementById('referralPopup');
            popup.style.display = 'none';
        };
        
        window.copyShareLink = function() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = 'var(--success)';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = 'var(--primary)';
            }, 2000);
        };
        
        // Check if user clicked a share link and load project data
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinParam = urlParams.get('join');
            
            if (joinParam && joinParam !== 'true') {
                // Load existing project data
                const savedProject = localStorage.getItem(joinParam);
                if (savedProject) {
                    const data = JSON.parse(savedProject);
                    projectData.members = data.members;
                    projectData.memberDetails = data.memberDetails;
                    projectData.startDate = new Date(data.startDate);
                    projectData.endDate = new Date(data.endDate);
                    projectData.brief = data.brief;
                    projectData.tasks = data.tasks;
                    projectData.taskNotes = data.taskNotes || {};
                    
                    // Store the project ID for later updates
                    localStorage.setItem('currentProjectId', joinParam);
                    
                    console.log('âœ… Loaded shared project with', data.members.length, 'members');
                    
                    // Update page 6 UI for shared project
                    setTimeout(() => {
                        const stepNumber = document.getElementById('page6StepNumber');
                        const title = document.getElementById('page6Title');
                        const subtitle = document.getElementById('page6Subtitle');
                        const buttonText = document.getElementById('generateButtonText');
                        
                        if (stepNumber) stepNumber.style.display = 'none';
                        if (title) title.textContent = 'Add Your Details';
                        if (subtitle) subtitle.innerHTML = 'Your teammate created a project! Click your name to add your <strong>strengths & availability</strong> so the AI can create a smarter schedule.';
                        if (buttonText) buttonText.textContent = 'Update Calendar';
                    }, 100);
                    
                    // Skip directly to page 6 (team details)
                    setTimeout(() => {
                        scrollToPage(6);
                    }, 500);
                }
            }
        });

        // Handle file upload
        window.handleFileUpload = async function(event) {
            const file = event.target.files[0];
            if (file) {
                const text = await file.text();
                document.getElementById('briefInput').value = text;
            }
        };

        // Generate project
        window.generateProject = async function() {
            // Check if this is a shared project (teammate joining)
            const projectId = localStorage.getItem('currentProjectId');
            const isSharedProject = projectId && projectId.startsWith('talli_project_');
            
            if (isSharedProject) {
                // Teammate is adding their info - regenerate tasks with updated data
                console.log('ðŸ”„ Regenerating tasks with updated team information...');
                
                // Save updated member details to shared project
                const savedProject = JSON.parse(localStorage.getItem(projectId));
                savedProject.memberDetails = projectData.memberDetails;
                localStorage.setItem(projectId, JSON.stringify(savedProject));
                
                // Show loading
                scrollToPage(7);
                animateProgressBar();
                
                const timeoutId = setTimeout(() => {
                    console.error('Regeneration timed out after 90 seconds');
                    alert('Taking longer than expected. Using existing tasks.');
                    renderCalendar();
                    scrollToPage(8);
                }, 90000); // 90 seconds
                
                try {
                    // Regenerate tasks with ALL team member details
                    projectData.tasks = await generateTasksFromBrief(
                        'My Project',
                        projectData.startDate,
                        projectData.endDate,
                        projectData.brief,
                        projectData.members
                    );
                    
                    clearTimeout(timeoutId);
                    
                    // Save updated tasks
                    savedProject.tasks = projectData.tasks;
                    localStorage.setItem(projectId, JSON.stringify(savedProject));
                    
                    console.log('âœ… Tasks regenerated with updated team info');
                    
                    // Show updated calendar directly (skip review for teammates)
                    setTimeout(() => {
                        renderCalendar();
                        scrollToPage(8);
                        alert('âœ… Calendar updated with your availability!');
                    }, 500);
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('âŒ Error regenerating tasks:', error);
                    alert('Could not regenerate tasks. Showing existing calendar.');
                    renderCalendar();
                    scrollToPage(8);
                }
                
                return;
            }
            
            // Original creator flow
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const brief = document.getElementById('briefInput').value;

            if (!brief.trim()) {
                alert('Please enter or upload your assignment brief!');
                return;
            }

            projectData.startDate = new Date(startDate);
            projectData.endDate = new Date(endDate);
            projectData.brief = brief;

            // Show loading page
            scrollToPage(7);

            // Animate progress bar
            animateProgressBar();
            
            // Set a timeout to prevent indefinite loading (90 seconds)
            const timeoutId = setTimeout(() => {
                console.error('Generation timed out after 90 seconds');
                alert('Generation is taking longer than expected. Using sample tasks instead.');
                projectData.tasks = generateFallbackTasks(
                    projectData.startDate,
                    projectData.endDate,
                    projectData.members
                );
                renderReviewScreen();
                scrollToPage(9);
            }, 90000); // 90 seconds

            try {
                console.log('ðŸš€ Starting task generation...');
                // Generate tasks with AI
                projectData.tasks = await generateTasksFromBrief(
                    'My Project',
                    projectData.startDate,
                    projectData.endDate,
                    projectData.brief,
                    projectData.members
                );
                
                clearTimeout(timeoutId);
                console.log('âœ… Tasks generated successfully:', projectData.tasks.length);

                // Show review screen instead of calendar
                setTimeout(() => {
                    renderReviewScreen();
                    scrollToPage(9);
                }, 500);

            } catch (error) {
                clearTimeout(timeoutId);
                console.error('âŒ Error generating project:', error);
                alert('Error generating tasks. Using sample tasks instead.');
                
                // Use fallback tasks
                projectData.tasks = generateFallbackTasks(
                    projectData.startDate,
                    projectData.endDate,
                    projectData.members
                );
                
                setTimeout(() => {
                    renderReviewScreen();
                    scrollToPage(9);
                }, 500);
            }
        };

        // Animate progress bar with steps
        function animateProgressBar() {
            const progressBar = document.getElementById('progressBarFill');
            const loadingMessage = document.getElementById('loadingMessage');
            const steps = ['step1', 'step2', 'step3', 'step4'];
            let currentStep = 0;

            // Rotating messages
            const messages = [
                "Analyzing your brief...",
                "Breaking down your assignment into specific tasks...",
                "Smart AI is distributing work evenly across your team...",
                "Almost done! Creating your personalized timeline..."
            ];

            // Reset all steps
            steps.forEach(step => {
                document.getElementById(step).classList.remove('active', 'complete');
            });

            // Animate through steps - slower to match actual AI processing time
            const stepDuration = 8000; // 8 seconds per step (32 sec total for realistic pacing)
            
            function activateStep(index) {
                // Update message
                if (loadingMessage && index < messages.length) {
                    loadingMessage.textContent = messages[index];
                }

                if (index > 0) {
                    document.getElementById(steps[index - 1]).classList.remove('active');
                    document.getElementById(steps[index - 1]).classList.add('complete');
                    document.getElementById(steps[index - 1]).querySelector('.step-icon').textContent = 'âœ“';
                }
                
                if (index < steps.length) {
                    document.getElementById(steps[index]).classList.add('active');
                    progressBar.style.width = `${((index + 1) / steps.length) * 100}%`;
                    
                    setTimeout(() => activateStep(index + 1), stepDuration);
                } else {
                    // All steps complete
                    document.getElementById(steps[steps.length - 1]).classList.remove('active');
                    document.getElementById(steps[steps.length - 1]).classList.add('complete');
                    document.getElementById(steps[steps.length - 1]).querySelector('.step-icon').textContent = 'âœ“';
                    progressBar.style.width = '100%';
                }
            }

            activateStep(0);
        }

        // Render calendar
        function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const legend = document.getElementById('legend');
    
    // DEBUG: Log all tasks that will be rendered
    console.log('ðŸ“… ========================================');
    console.log('ðŸ“… RENDERING CALENDAR');
    console.log('ðŸ“… ========================================');
    console.log('   Total tasks:', projectData.tasks ? projectData.tasks.length : 0);
    console.log('   Start date:', projectData.startDate ? projectData.startDate.toLocaleDateString() : 'Not set');
    console.log('   End date:', projectData.endDate ? projectData.endDate.toLocaleDateString() : 'Not set');
    console.log('   ');
    console.log('   ðŸ“‹ All tasks that will be displayed:');
    if (projectData.tasks) {
        projectData.tasks.forEach((task, i) => {
            console.log(`   ${i + 1}. ${task.name}`);
            console.log(`      Assignee: ${task.assignee}`);
            console.log(`      Due: ${new Date(task.dueDate).toLocaleDateString()}`);
        });
    }
    console.log('ðŸ“… ========================================');
    
    // Update project ID display
    updateProjectIdDisplay();
    
    if (!grid || !legend) {
        console.error('âŒ Calendar elements not found!');
        return;
    }
    
    try {
        // Check if we have no tasks - show empty state
        if (!projectData.tasks || projectData.tasks.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; text-align: center; min-height: 400px;">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--text-light)" stroke-width="1.5" style="margin-bottom: 1.5rem; opacity: 0.5;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 0.5rem;">No Tasks Yet</h3>
                    <p style="color: var(--text-light); font-size: 1rem; max-width: 400px;">
                        ${currentProjectId ? 'The project host needs to generate tasks first. Ask them to create the project timeline!' : 'Create a project to generate your timeline.'}
                    </p>
                </div>
            `;
            legend.innerHTML = '';
            return;
        }
        
        // Check if we have dates
        if (!projectData.startDate || !projectData.endDate) {
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; text-align: center; min-height: 400px;">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--text-light)" stroke-width="1.5" style="margin-bottom: 1.5rem; opacity: 0.5;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 0.5rem;">Missing Project Dates</h3>
                    <p style="color: var(--text-light); font-size: 1rem;">Please set project start and end dates.</p>
                </div>
            `;
            legend.innerHTML = '';
            return;
        }
    } catch (error) {
        console.error('âŒ Error in renderCalendar validation:', error);
        alert('Error rendering calendar: ' + error.message);
        return;
    }
    
    // Create legend - add "Everyone" and "Rest Day"
    const allMembers = [...projectData.members, 'Everyone', 'Rest Day'];
    
    // Color map that matches CSS classes
    const getColorForMember = (member) => {
        if (member === 'Rest Day') return '#E5E7EB';
        if (member === 'Everyone') return '#9FBDAE';
        const index = projectData.members.indexOf(member);
        const colorMap = ['#FFB3E6', '#FFE5B3', '#B3D9FF', '#D4B3FF', '#B3FFD9'];
        return colorMap[index % 5];
    };
    
    legend.innerHTML = allMembers.map((member) => {
        const bgColor = getColorForMember(member);
        const isClickable = member !== 'Rest Day';
        const clickHandler = isClickable ? `onclick="openTodoSidebar('${member}')"` : '';
        const clickableClass = isClickable ? 'clickable' : '';
        const tooltip = isClickable ? `data-tooltip="View ${member === 'Everyone' ? 'team' : member + "'s"} tasks"` : '';
        return `
            <div class="legend-item ${clickableClass}" ${clickHandler} ${tooltip}>
                <div class="legend-color" style="background: ${bgColor};"></div>
                <span>${member}</span>
            </div>
        `;
    }).join('');

            // Calculate calendar days - add 1 to include end date
    const duration = Math.ceil((projectData.endDate - projectData.startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    console.log('ðŸ“… Calendar duration:', duration, 'days');
    console.log('   From:', projectData.startDate.toLocaleDateString());
    console.log('   To:', projectData.endDate.toLocaleDateString());
    
    // Get the day of week for start date (0 = Sunday, 1 = Monday, etc.)
    const startDay = projectData.startDate.getDay();
    
    // Add empty cells to align with correct day of week
    // Convert Sunday (0) to be at the end (make Monday = 0)
    const offset = startDay === 0 ? 6 : startDay - 1;
    
    let html = '';
    
    // Add empty cells for alignment
    for (let i = 0; i < offset; i++) {
        html += '<div class="calendar-day calendar-day-empty"></div>';
    }
    
    // Rest of the function stays the same...
            for (let i = 0; i < Math.min(duration, 42); i++) {
                const date = new Date(projectData.startDate);
                date.setDate(date.getDate() + i);
                
                let tasksOnDay = projectData.tasks.filter(task => {
                    const taskDate = new Date(task.dueDate);
                    return taskDate.toDateString() === date.toDateString();
                });
                
                // Debug logging for last day
                if (date.getDate() === 20 && date.getMonth() === 1) { // Feb 20
                    console.log('ðŸ” Tasks on Feb 20:', tasksOnDay.length);
                    tasksOnDay.forEach(t => console.log('   -', t.name));
                }

                // Check if this day has a meeting (Mid-Project Review, Final Content Review, or Kickoff)
                const hasMeeting = tasksOnDay.some(task => 
                    task.name.toLowerCase().includes('meeting') || 
                    task.name.toLowerCase().includes('review meeting')
                );
                
                // If it's a meeting day, only keep the meeting task(s)
                if (hasMeeting) {
                    tasksOnDay = tasksOnDay.filter(task => 
                        task.name.toLowerCase().includes('meeting') ||
                        task.assignee === 'Everyone'
                    );
                }

                // ONLY mark as rest day if there are NO tasks at all (don't override existing tasks)
                if (tasksOnDay.length === 0) {
                    tasksOnDay = [{
                        name: 'Rest Day',
                        assignee: 'Rest Day',
                        dueDate: date.toISOString()
                    }];
                }

                // Get unique assignees for this day
                const uniqueAssignees = [...new Set(tasksOnDay.map(t => t.assignee))];
                
                // Function to get color for any assignee
                const getAssigneeColor = (assignee) => {
                    if (assignee === 'Rest Day') return '#E5E7EB';
                    if (assignee === 'Everyone') return '#9FBDAE';
                    const index = projectData.members.indexOf(assignee);
                    const colorMap = ['#FFB3E6', '#FFE5B3', '#B3D9FF', '#D4B3FF', '#B3FFD9'];
                    return colorMap[index % 5];
                };
                
                // Create gradient for multiple people or solid color for single person/rest
                let backgroundStyle = '';
                const isRestDay = tasksOnDay.length === 1 && tasksOnDay[0].assignee === 'Rest Day';
                const isGroupMeeting = tasksOnDay.some(t => t.assignee === 'Everyone' || t.name.toLowerCase().includes('meeting'));
                
                if (isRestDay) {
                    // Light gray for rest days
                    backgroundStyle = `background-color: #E5E7EB;`;
                } else if (isGroupMeeting) {
                    // Green for meeting/Everyone days
                    backgroundStyle = `background-color: #9FBDAE;`;
                } else if (uniqueAssignees.length > 1) {
                    // Multiple people - create gradient
                    const colors = uniqueAssignees.map(assignee => getAssigneeColor(assignee));
                    backgroundStyle = `background: linear-gradient(135deg, ${colors.join(', ')});`;
                } else {
                    // Single person
                    const color = getAssigneeColor(uniqueAssignees[0]);
                    backgroundStyle = `background-color: ${color};`;
                }
                
                html += `
                    <div class="calendar-day has-task" style="${backgroundStyle}" data-date="${date.toISOString()}" onclick='openTaskModal(new Date("${date.toISOString()}"))'>
                        <div class="day-number">${date.getDate()}</div>
                        <div class="task-list-desktop">
                        ${tasksOnDay
                            .sort((a, b) => {
                                // Prioritize Final Submission and meetings to show first
                                const aIsFinal = a.name.toLowerCase().includes('submission') || a.name.toLowerCase().includes('submit');
                                const bIsFinal = b.name.toLowerCase().includes('submission') || b.name.toLowerCase().includes('submit');
                                const aIsMeeting = a.name.toLowerCase().includes('meeting');
                                const bIsMeeting = b.name.toLowerCase().includes('meeting');
                                
                                if (aIsFinal && !bIsFinal) return -1;
                                if (!aIsFinal && bIsFinal) return 1;
                                if (aIsMeeting && !bIsMeeting) return -1;
                                if (!aIsMeeting && bIsMeeting) return 1;
                                return 0;
                            })
                            .slice(0, 3)
                            .map(task => {
                                const isMeeting = task.name.toLowerCase().includes('meeting');
                                const isRest = task.name.toLowerCase().includes('rest');
                                const isFinalSubmission = task.name.toLowerCase() === 'final submission';
                                
                                // Special styling for Final Submission - refined, professional look
                                if (isFinalSubmission) {
                                    return `<div class="task-indicator" style="background: linear-gradient(135deg, #4A6B5A, #2F4538); color: white; font-weight: 700; font-size: 0.85rem; padding: 0.6rem 0.75rem; border-radius: 8px; white-space: normal; line-height: 1.3; text-align: left; display: flex; align-items: center; gap: 0.5rem;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>Final Submission</div>`;
                                }
                                
                                const textColor = isRestDay ? '#6B7280' : (isMeeting ? '#004E89' : '#2F4538');
                                const fontWeight = isMeeting ? '900' : '600';
                                const completedStyle = task.completed ? 'opacity: 0.5; text-decoration: line-through;' : '';
                                return `<div class="task-indicator task-item" data-task-id="${task.id}" draggable="${!isRest}" style="background: rgba(255,255,255,0.9); color: ${textColor}; font-weight: ${fontWeight}; ${completedStyle}">${task.name}</div>`;
                            }).join('')}
                        ${tasksOnDay.length > 3 ? `<div class="task-indicator" style="background: rgba(255,255,255,0.9);">+${tasksOnDay.length - 3} more</div>` : ''}
                        </div>
                        <div class="task-icons-mobile">
                            ${tasksOnDay.slice(0, 4).map(task => {
                                const isMeeting = task.name.toLowerCase().includes('meeting');
                                const isFinal = task.name.toLowerCase().includes('submission');
                                const isRest = task.name.toLowerCase().includes('rest');
                                // Get color for this task's assignee
                                let dotColor = '#E5E7EB'; // default gray
                                if (isRest) {
                                    dotColor = '#E5E7EB';
                                } else if (isMeeting || task.assignee === 'Everyone') {
                                    dotColor = '#4A6B5A';
                                } else if (isFinal) {
                                    dotColor = '#2F4538';
                                } else {
                                    dotColor = getAssigneeColor(task.assignee);
                                }
                                return `<div class="task-icon-dot" style="background: ${dotColor};"></div>`;
                            }).join('')}
                            ${tasksOnDay.length > 4 ? `<div class="task-icon-more">+${tasksOnDay.length - 4}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            
            // Setup drag and drop after rendering
            setupDragAndDrop();
            
            // Show progress circle
            toggleProgressCircle();
        }



        // Set default dates
        document.getElementById('startDate').valueAsDate = new Date();
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + 30);
        document.getElementById('endDate').valueAsDate = futureDate;

        // Add scroll wheel detection
        let isScrolling = false;
        let scrollThreshold = 50; // Minimum scroll amount needed to trigger
        
        window.addEventListener('wheel', (event) => {
            // Don't trigger on calendar page (page 8) so user can scroll the calendar
            if (currentPage === 8) return;
            
            // Don't trigger on review page (page 9) - user should use approve button
            if (currentPage === 9) return;
            
            // Don't trigger on loading page (page 7) - wait for generation
            if (currentPage === 7) return;
            
            // Don't trigger on team details page (page 6) so user can scroll skills form
            if (currentPage === 6) return;
            
            if (isScrolling) return;
            
            // Check if scroll is strong enough
            if (Math.abs(event.deltaY) < scrollThreshold) return;
            
            isScrolling = true;

            // Scroll down = go to next page (but not past page 6 - user must click generate)
            if (event.deltaY > 0 && currentPage < 6) {
                scrollToPage(currentPage + 1);
            }
            // Scroll up = go to previous page (but not from protected pages)
            else if (event.deltaY < 0 && currentPage > 1 && currentPage <= 6) {
                scrollToPage(currentPage - 1);
            }

            // Prevent rapid scrolling - increased to 1.5 seconds
            setTimeout(() => {
                isScrolling = false;
            }, 1500);
        });

        // Touch/swipe support for mobile
        let touchStartY = 0;
        let touchEndY = 0;
        const swipeThreshold = 50;

        document.addEventListener('touchstart', (e) => {
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            // Don't trigger on certain pages
            if (currentPage === 7 || currentPage === 8 || currentPage === 9) return;
            if (currentPage === 6) return; // Team details page
            
            if (isScrolling) return;
            
            touchEndY = e.changedTouches[0].screenY;
            const swipeDistance = touchStartY - touchEndY;
            
            if (Math.abs(swipeDistance) < swipeThreshold) return;
            
            isScrolling = true;
            
            // Swipe up = go to next page
            if (swipeDistance > 0 && currentPage < 6) {
                scrollToPage(currentPage + 1);
            }
            // Swipe down = go to previous page
            else if (swipeDistance < 0 && currentPage > 1 && currentPage <= 6) {
                scrollToPage(currentPage - 1);
            }
            
            setTimeout(() => {
                isScrolling = false;
            }, 1000);
        }, { passive: true });

        // Initialize
        updateProgress();
        
        // Make sure page 1 is visible on load
        const page1 = document.getElementById('page1');
        page1.classList.remove('hidden');
        page1.classList.add('active');
        page1.style.opacity = '1';
        page1.style.transform = 'translateY(0)';

        // Service worker disabled - enable by creating service-worker.js file
        // if ('serviceWorker' in navigator) {
        //     navigator.serviceWorker.register('/service-worker.js')
        //         .then(registration => console.log('Service Worker registered'))
        //         .catch(err => console.log('Service Worker registration failed', err));
        // }

        // ========== NEW FEATURES ==========

        // Task Review Screen
        function renderReviewScreen() {
            console.log('ðŸ“‹ ========================================');
            console.log('ðŸ“‹ REVIEW SCREEN - Showing tasks for review');
            console.log('ðŸ“‹ ========================================');
            console.log('   Total tasks:', projectData.tasks.length);
            console.log('   First 5 tasks with dates:');
            projectData.tasks.slice(0, 5).forEach((task, i) => {
                console.log(`   ${i + 1}. ${task.name} - Due: ${new Date(task.dueDate).toLocaleDateString()}`);
            });
            console.log('   Last 5 tasks with dates:');
            projectData.tasks.slice(-5).forEach((task, i) => {
                const actualIndex = projectData.tasks.length - 5 + i;
                console.log(`   ${actualIndex + 1}. ${task.name} - Due: ${new Date(task.dueDate).toLocaleDateString()}`);
            });
            console.log('ðŸ“‹ ========================================');
            
            const list = document.getElementById('reviewTasksList');
            list.innerHTML = projectData.tasks.map((task, index) => `
                <div class="review-task-item" id="review-task-${index}">
                    <div class="review-task-row">
                        <textarea 
                            class="review-task-input review-task-name" 
                            onchange="updateTaskName(${index}, this.value)"
                            placeholder="Task name"
                        >${task.name}</textarea>
                        <input 
                            type="text" 
                            class="review-task-input" 
                            value="${task.assignee}"
                            onchange="updateTaskAssignee(${index}, this.value)"
                            placeholder="Assignee"
                        >
                        <input 
                            type="date" 
                            class="review-task-input" 
                            value="${new Date(task.dueDate).toISOString().split('T')[0]}"
                            onchange="updateTaskDate(${index}, this.value)"
                        >
                        <button class="delete-task-btn" onclick="deleteTask(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.updateTaskName = function(index, name) {
            projectData.tasks[index].name = name;
            console.log('âœï¸ Updated task name:', name);
        };

        window.updateTaskAssignee = function(index, assignee) {
            projectData.tasks[index].assignee = assignee;
            console.log('âœï¸ Updated assignee:', assignee);
        };

        window.updateTaskDate = function(index, date) {
            projectData.tasks[index].dueDate = new Date(date).toISOString();
            console.log('âœï¸ Updated date:', date);
        };

        window.deleteTask = function(index) {
            if (confirm('Delete this task?')) {
                projectData.tasks.splice(index, 1);
                renderReviewScreen();
            }
        };

        window.addNewTask = function() {
            const newTask = {
                id: `task_${Date.now()}`,
                name: 'New Task',
                assignee: projectData.members[0] || 'Unassigned',
                dueDate: new Date(projectData.startDate).toISOString(),
                description: '',
                completed: false
            };
            projectData.tasks.push(newTask);
            renderReviewScreen();
        };

        window.approveTasks = async function() {
            try {
                console.log('ðŸ“‹ Approving tasks...');
                console.log('   Tasks count:', projectData.tasks ? projectData.tasks.length : 0);
                console.log('   Start date:', projectData.startDate);
                console.log('   End date:', projectData.endDate);
                
                // Validate we have tasks
                if (!projectData.tasks || projectData.tasks.length === 0) {
                    alert('âŒ No tasks to approve! Please generate tasks first.');
                    return;
                }
                
                // Validate we have dates
                if (!projectData.startDate || !projectData.endDate) {
                    alert('âŒ Missing project dates! Please set start and end dates.');
                    return;
                }
                
                // Save project data to localStorage for peer assessment page
                localStorage.setItem('talliProjectData', JSON.stringify({
                    members: projectData.members,
                    memberDetails: projectData.memberDetails,
                    tasks: projectData.tasks,
                    startDate: projectData.startDate,
                    endDate: projectData.endDate,
                    taskNotes: projectData.taskNotes || {},
                    name: projectData.name || 'Group Project'
                }));
                console.log('ðŸ’¾ Project data saved to localStorage');
                
                console.log('âœ… Validation passed, navigating to calendar...');
                console.log('ðŸ“‹ Current tasks being used:');
                projectData.tasks.forEach((task, i) => {
                    console.log(`   ${i + 1}. ${task.name} - ${task.assignee} - ${new Date(task.dueDate).toLocaleDateString()}`);
                });
                
                // Navigate to calendar page FIRST, then render
                console.log('ðŸ”„ Current page:', currentPage, 'â†’ Going to page 8');
                scrollToPage(8);
                
                // Wait for page transition, then render
                setTimeout(() => {
                    console.log('ðŸ“… Now on page:', currentPage, '- Rendering calendar...');
                    renderCalendar();
                    console.log('âœ… Calendar rendered, checking Firebase...');
                }, 500);
                
                // Check if Firebase is ready
                if (!window.firebaseReady || !window.db) {
                    console.log('âš ï¸ Firebase not ready, working offline');
                    alert('âš ï¸ Firebase not connected.\n\nYour project will work but cannot be shared in real-time. Check your internet connection and reload to enable sharing.');
                    return;
                }
                
                // CRITICAL: Check if we already have a project ID (from URL or previous creation)
                if (currentProjectId) {
                    console.log('âœ… Already connected to project:', currentProjectId);
                    console.log('ðŸ’¾ Updating existing project instead of creating new one');
                    
                    // Update the existing project instead of creating a new one
                    await updateFirebaseProject();
                    showShareModal(currentProjectId);
                    return;
                }
                
                // Create Firebase project and show share link
                console.log('ðŸ”„ Creating NEW Firebase project...');
                const projectId = await createFirebaseProject();
                
                if (projectId) {
                    console.log('âœ… Project created successfully:', projectId);
                } else {
                    console.error('âŒ Failed to create project');
                    alert('Failed to create shareable project. Your calendar will work locally only.');
                }
            } catch (error) {
                console.error('âŒ Error in approveTasks:', error);
                alert('Error: ' + error.message);
            }
        };

        // Task Detail Modal
        window.openTaskModal = function(date) {
            const modal = document.getElementById('taskModal');
            const modalDate = document.getElementById('modalDate');
            const modalTasksList = document.getElementById('modalTasksList');

            // Format date
            modalDate.textContent = date.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Get tasks for this day
            const tasksOnDay = projectData.tasks.filter(task => {
                const taskDate = new Date(task.dueDate);
                return taskDate.toDateString() === date.toDateString();
            });

            // Render tasks
            if (tasksOnDay.length === 0) {
                modalTasksList.innerHTML = `
                    <div class="task-detail-item">
                        <p style="text-align: center; color: var(--text-light);">
                            Rest Day - No tasks scheduled
                        </p>
                    </div>
                `;
            } else {
                modalTasksList.innerHTML = tasksOnDay.map(task => {
                    // Get assignee color
                    const getColorForAssignee = (assignee) => {
                        if (assignee === 'Rest Day') return '#E5E7EB';
                        if (assignee === 'Everyone') return '#9FBDAE';
                        const index = projectData.members.indexOf(assignee);
                        const colorMap = ['#FFB3E6', '#FFE5B3', '#B3D9FF', '#D4B3FF', '#B3FFD9'];
                        return colorMap[index % 5] || '#E5E7EB';
                    };
                    
                    // Get darker shade for button
                    const getDarkerShade = (color) => {
                        const colorMap = {
                            '#FFB3E6': '#E91E8C',  // Pink -> Darker pink
                            '#FFE5B3': '#FFB02E',  // Yellow -> Darker yellow
                            '#B3D9FF': '#2E7DFF',  // Blue -> Darker blue
                            '#D4B3FF': '#8E2EFF',  // Purple -> Darker purple
                            '#B3FFD9': '#2EFF8E',  // Green -> Darker green
                            '#9FBDAE': '#4A6B5A',  // Everyone -> Dark green
                            '#E5E7EB': '#9CA3AF'   // Rest Day -> Gray
                        };
                        return colorMap[color] || '#4A6B5A';
                    };
                    
                    const bgColor = getColorForAssignee(task.assignee);
                    const buttonColor = getDarkerShade(bgColor);
                    const isMeeting = task.name.toLowerCase().includes('meeting');
                    
                    return `
                        <div class="task-detail-item" style="background: ${bgColor}; border-color: ${bgColor};">
                            <div class="task-detail-header">
                                <input 
                                    type="checkbox" 
                                    class="task-checkbox"
                                    ${task.completed ? 'checked' : ''}
                                    onchange="toggleTaskComplete('${task.id}', this.checked)"
                                >
                                <div class="task-detail-info">
                                    <div class="task-detail-name">${task.name}</div>
                                    <div class="task-detail-assignee" style="font-weight: 700; background: ${buttonColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; display: inline-block;">${task.assignee}</div>
                                    ${task.description ? `<div class="task-detail-description">${task.description}</div>` : ''}
                                    ${isMeeting ? `
                                        <button onclick="startVideoMeeting('${task.name}')" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #10B981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                            </svg>
                                            Start Video Call
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="task-notes-section">
                                <label class="task-notes-label">What did you accomplish?</label>
                                <textarea 
                                    class="task-notes-input" 
                                    id="notes-${task.id}"
                                    placeholder="Brief note about what was completed..."
                                >${projectData.taskNotes[task.id] || ''}</textarea>
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                    <button class="save-notes-btn" style="background: ${buttonColor};" onclick="saveTaskNote('${task.id}')">
                                        Save Note
                                    </button>
                                    <button onclick="openChatbotForReschedule('${task.id}')" style="background: none; border: none; color: #6B7F75; font-size: 0.85rem; cursor: pointer; text-decoration: underline; padding: 0.5rem; font-weight: 500;">
                                        Need to reschedule? Ask for help â†’
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            modal.classList.add('active');
        };

        window.closeTaskModal = function() {
            document.getElementById('taskModal').classList.remove('active');
        };

        window.toggleTaskComplete = function(taskId, completed) {
            const task = projectData.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = completed;
                if (completed) {
                    task.completedAt = new Date().toISOString();
                }
                renderCalendar(); // Refresh calendar
                updateProgressCircle(); // Update progress
            }
        };

        window.saveTaskNote = function(taskId) {
            const noteText = document.getElementById(`notes-${taskId}`).value;
            projectData.taskNotes[taskId] = noteText;
            
            // Update Firebase
            if (currentProjectId) {
                updateFirebaseProject();
            }
            
            alert('âœ… Note saved!');
        };
        
        // Open chatbot with task context
        window.openChatbotForReschedule = function(taskId) {
            const task = projectData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Close modal
            closeTaskModal();
            
            // Open chatbot
            const chatbotPanel = document.getElementById('chatbotPanel');
            const chatbotButton = document.getElementById('chatbotButton');
            
            if (chatbotPanel && chatbotButton) {
                chatbotPanel.style.display = 'flex';
                chatbotButton.style.display = 'none';
                
                // Find task index
                const taskIndex = projectData.tasks.findIndex(t => t.id === taskId);
                
                // Add helpful message
                setTimeout(() => {
                    addChatMessage(`I can help you reschedule "${task.name}"!\n\nJust tell me when you'd like to move it to. For example: "Move to Friday" or "Next Tuesday"`, 'assistant');
                    
                    // Pre-fill input
                    const input = document.getElementById('chatInput');
                    if (input) {
                        input.placeholder = `e.g., "move task ${taskIndex + 1} to friday"`;
                    }
                }, 300);
            }
        };
        
        // Start video meeting
        window.startVideoMeeting = function(meetingName) {
            const modal = document.createElement('div');
            modal.id = 'videoMeetingModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10001; display: flex; align-items: center; justify-content: center; cursor: pointer;';
            modal.onclick = function(e) {
                if (e.target === modal) closeVideoMeetingModal();
            };
            
            const projectName = projectData.name || 'Group Project';
            const roomName = `${projectName}-${meetingName.replace(/\s+/g, '-').toLowerCase()}`;
            
            modal.innerHTML = `
                <div onclick="event.stopPropagation()" style="background: white; padding: 2.5rem; border-radius: 20px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; cursor: default;">
                    <button onclick="closeVideoMeetingModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6B7F75;">Ã—</button>
                    
                    <div style="margin-bottom: 1rem;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#4A6B5A" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                    </div>
                    <h2 style="font-size: 1.8rem; font-weight: 800; color: #4A6B5A; margin-bottom: 1rem;">${meetingName}</h2>
                    
                    <p style="color: #2F4538; font-size: 1.1rem; margin-bottom: 2rem;">
                        Choose how you'd like to meet with your team
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <button onclick="openVideoService('jitsi', '${roomName}')" style="padding: 1.25rem; background: #10B981; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg>
                            Start Instant Video Call (Jitsi)
                        </button>
                        
                        <button onclick="openVideoService('zoom', '${roomName}')" style="padding: 1.25rem; background: #2D8CFF; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15.5 5H8.5C6.5 5 5 6.5 5 8.5v7c0 2 1.5 3.5 3.5 3.5h7c2 0 3.5-1.5 3.5-3.5v-7c0-2-1.5-3.5-3.5-3.5z"></path>
                            </svg>
                            Open Zoom
                        </button>
                        
                        <button onclick="openVideoService('meet', '${roomName}')" style="padding: 1.25rem; background: #EA4335; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                                <polyline points="17 2 12 7 7 2"></polyline>
                            </svg>
                            Open Google Meet
                        </button>
                        
                        <button onclick="copyMeetingLink('${roomName}')" style="padding: 1.25rem; background: #6B7F75; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                            Copy Meeting Link
                        </button>
                    </div>
                    
                    <p style="font-size: 0.85rem; color: #6B7F75; margin-top: 1.5rem;">
                        ðŸ’¡ Tip: Share the link with your team so everyone can join!
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.closeVideoMeetingModal = function() {
            const modal = document.getElementById('videoMeetingModal');
            if (modal) modal.remove();
        };
        
        window.openVideoService = function(service, roomName) {
            let url = '';
            
            if (service === 'jitsi') {
                // Jitsi Meet - free, instant, no account needed
                url = `https://meet.jit.si/${roomName}`;
            } else if (service === 'zoom') {
                url = 'https://zoom.us/';
            } else if (service === 'meet') {
                url = 'https://meet.google.com/';
            }
            
            window.open(url, '_blank');
            
            // Close modal
            closeVideoMeetingModal();
            
            // Show success message
            alert(`âœ… Opening ${service === 'jitsi' ? 'Jitsi Meet' : service === 'zoom' ? 'Zoom' : 'Google Meet'}!\n\nShare the link with your team so they can join.`);
        };
        
        window.copyMeetingLink = function(roomName) {
            const link = `https://meet.jit.si/${roomName}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(link).then(() => {
                alert(`âœ… Meeting link copied!\n\n${link}\n\nShare this with your team to join the call.`);
                closeVideoMeetingModal();
            }).catch(() => {
                // Fallback
                prompt('Copy this meeting link:', link);
                closeVideoMeetingModal();
            });
        };

        // Peer Assessment Generation
        window.generatePeerAssessment = function() {
            const completedTasks = projectData.tasks.filter(t => t.completed);
            
            let report = `PEER ASSESSMENT REPORT\n`;
            report += `${'='.repeat(60)}\n\n`;
            report += `Project: ${projectData.name || 'Group Project'}\n`;
            report += `Period: ${projectData.startDate.toLocaleDateString()} - ${projectData.endDate.toLocaleDateString()}\n`;
            report += `Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}\n\n`;
            report += `${'='.repeat(60)}\n\n`;
            
            report += `TEAM MEMBERS:\n${projectData.members.join(', ')}\n\n`;
            report += `${'='.repeat(60)}\n\n`;
            
            report += `CONTRIBUTION SUMMARY:\n\n`;
            
            projectData.members.forEach(member => {
                const memberTasks = projectData.tasks.filter(t => t.assignee === member);
                const memberCompleted = memberTasks.filter(t => t.completed);
                const completionRate = memberTasks.length > 0 ? Math.round((memberCompleted.length / memberTasks.length) * 100) : 0;
                
                report += `${member.toUpperCase()}:\n`;
                report += `${'-'.repeat(40)}\n`;
                report += `Tasks Assigned: ${memberTasks.length}\n`;
                report += `Tasks Completed: ${memberCompleted.length}\n`;
                report += `Completion Rate: ${completionRate}%\n\n`;
                
                if (memberCompleted.length > 0) {
                    report += `Completed Tasks:\n`;
                    memberCompleted.forEach(task => {
                        report += `  â€¢ ${task.name}\n`;
                        report += `    Due: ${new Date(task.dueDate).toLocaleDateString()}\n`;
                        if (task.completedAt) {
                            report += `    Completed: ${new Date(task.completedAt).toLocaleDateString()}\n`;
                        }
                        if (projectData.taskNotes[task.id]) {
                            report += `    Notes: ${projectData.taskNotes[task.id]}\n`;
                        }
                        report += `\n`;
                    });
                }
                report += `\n`;
            });
            
            report += `${'='.repeat(60)}\n\n`;
            report += `GROUP TASKS COMPLETED:\n`;
            const groupTasks = completedTasks.filter(t => t.assignee === 'Everyone');
            if (groupTasks.length > 0) {
                groupTasks.forEach(task => {
                    report += `  â€¢ ${task.name} - ${new Date(task.dueDate).toLocaleDateString()}\n`;
                    if (projectData.taskNotes[task.id]) {
                        report += `    ${projectData.taskNotes[task.id]}\n`;
                    }
                });
            } else {
                report += `No group tasks completed yet.\n`;
            }
            
            report += `\n${'='.repeat(60)}\n`;
            report += `\nEND OF REPORT\n`;
            
            // Download report as text file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `peer_assessment_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… Peer assessment report downloaded! Upload to Moodle.');
        };

        // ========== NEW FEATURES ==========

        // Dark Mode Toggle
        // Reset App (logo click)
        window.resetApp = function() {
            // Prevent reset when on calendar page
            if (currentPage === 8) {
                console.log('ðŸ”’ Cannot reset while viewing calendar');
                return;
            }
            
            if (confirm('Start a new project? This will reset everything.')) {
                projectData = {
                    members: [],
                    startDate: null,
                    endDate: null,
                    brief: '',
                    tasks: [],
                    taskNotes: {}
                };
                currentPage = 1;
                scrollToPage(1);
                location.reload();
            }
        };
        
        // Show share link modal again
        window.showShareLinkAgain = function() {
            if (!currentProjectId) {
                alert('No project created yet. Create a project first!');
                return;
            }
            showShareModal(currentProjectId);
        };
        
        // Force sync with Firebase (manual sync button)
        window.forceSync = async function() {
            if (!currentProjectId || !window.db) {
                alert('âŒ No active project or Firebase not connected');
                return;
            }
            
            try {
                console.log('ðŸ”„ Force syncing from Firebase...');
                
                // Show loading indicator
                const btn = event?.target?.closest('button');
                const originalText = btn ? btn.innerHTML : '';
                if (btn) {
                    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 11-6.219-8.56"></path></svg> Syncing...';
                    btn.disabled = true;
                }
                
                const doc = await window.db.collection('projects').doc(currentProjectId).get();
                
                if (!doc.exists) {
                    alert('âŒ Project not found in Firebase');
                    return;
                }
                
                const data = doc.data();
                
                // Update local data
                projectData.members = data.members || [];
                projectData.memberDetails = data.memberDetails || {};
                projectData.startDate = data.startDate ? new Date(data.startDate) : null;
                projectData.endDate = data.endDate ? new Date(data.endDate) : null;
                projectData.brief = data.brief || '';
                projectData.tasks = data.tasks || [];
                projectData.taskNotes = data.taskNotes || {};
                
                console.log('âœ… Synced - Tasks:', projectData.tasks.length);
                console.log('âœ… Synced - Members:', projectData.members.length);
                
                // Refresh calendar
                if (window.currentPage === 8) {
                    renderCalendar();
                }
                
                showSyncIndicator();
                
                // Reset button
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
                
                // Show success message
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; top: 6rem; right: 2rem; background: #10B981; color: white; padding: 1rem 1.5rem; border-radius: 12px; font-weight: 700; z-index: 999; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);';
                toast.textContent = `âœ“ Synced! ${projectData.tasks.length} tasks`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
                
            } catch (error) {
                console.error('âŒ Force sync failed:', error);
                alert('Sync failed: ' + error.message);
                
                // Reset button on error
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };
        
        // Regenerate tasks based on updated availability
        window.regenerateWithAvailability = async function() {
            if (!confirm('Regenerate tasks with updated team availability?\n\nThis will:\nâœ“ Keep your team members\nâœ“ Respect new availability info\nâœ“ Reassign tasks based on skills\n\nâš ï¸ Any manual task edits will be lost.')) {
                return;
            }
            
            console.log('ðŸ”„ Regenerating tasks with updated availability...');
            
            // Show loading page
            scrollToPage(7);
            animateProgressBar();
            
            try {
                // Re-generate tasks with updated availability
                const newTasks = await generateTasksFromBrief(
                    'Project',
                    projectData.startDate,
                    projectData.endDate,
                    projectData.brief,
                    projectData.members
                );
                
                projectData.tasks = newTasks;
                
                // Update Firebase if connected
                if (currentProjectId) {
                    await updateFirebaseProject();
                    console.log('âœ… Updated project in Firebase');
                }
                
                // Show updated calendar
                setTimeout(() => {
                    renderCalendar();
                    scrollToPage(8);
                    alert('âœ… Tasks regenerated with updated availability!');
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Regeneration failed:', error);
                alert('Failed to regenerate tasks. Please try again.');
                scrollToPage(8); // Go back to calendar
            }
        };

        // Calculate Progress Percentage
        function calculateProgress() {
            if (projectData.tasks.length === 0) return 0;
            const completed = projectData.tasks.filter(t => t.completed).length;
            return Math.round((completed / projectData.tasks.length) * 100);
        }

        // Update Progress Circle
        function updateProgressCircle() {
            const progress = calculateProgress();
            const circle = document.getElementById('progressCircleFill');
            const text = document.getElementById('progressText');
            
            if (circle && text) {
                const circumference = 188; // 2 * Ï€ * 30 (radius)
                const offset = circumference - (progress / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                text.textContent = `${progress}%`;
            }
        }

        // Show/hide progress circle on loading and calendar pages
        function toggleProgressCircle() {
            const progressCircle = document.getElementById('progressCircle');
            if (currentPage === 7 || currentPage === 8) {
                progressCircle.style.display = 'block';
                updateProgressCircle();
            } else {
                progressCircle.style.display = 'none';
            }
        }

        // Export to Google Calendar / Outlook (.ics format)
        window.exportToGoogleCalendar = function() {
            // Create ICS file content
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Tally App//Group Project Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${projectData.name || 'Tally Project'}
X-WR-TIMEZONE:Europe/London
BEGIN:VTIMEZONE
TZID:Europe/London
END:VTIMEZONE
`;

            projectData.tasks.forEach(task => {
                const taskDate = new Date(task.dueDate);
                const dateStr = taskDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const uid = `${task.id}@tallyapp.com`;
                
                icsContent += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dateStr}
DTSTART:${dateStr}
DTEND:${dateStr}
SUMMARY:${task.name}
DESCRIPTION:Assigned to: ${task.assignee}${task.description ? '\\n' + task.description : ''}
LOCATION:
STATUS:${task.completed ? 'COMPLETED' : 'CONFIRMED'}
TRANSP:OPAQUE
END:VEVENT
`;
            });

            icsContent += 'END:VCALENDAR';

            // Download ICS file
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tally_project_${new Date().toISOString().split('T')[0]}.ics`;
            a.click();
            
            alert('ðŸ“… Calendar exported! Import this file into Google Calendar, Outlook, or Apple Calendar.');
        };

        // Drag and Drop functionality
        let draggedTask = null;
        let draggedTaskDate = null;

        function setupDragAndDrop() {
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;

            calendarGrid.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('task-indicator')) {
                    e.target.classList.add('dragging');
                    
                    // Find which task and date this is
                    const dayEl = e.target.closest('.calendar-day');
                    const dateStr = dayEl.getAttribute('data-date');
                    const taskName = e.target.textContent;
                    
                    // Find the task
                    const date = new Date(dateStr);
                    const tasksOnDay = projectData.tasks.filter(task => {
                        const taskDate = new Date(task.dueDate);
                        return taskDate.toDateString() === date.toDateString();
                    });
                    
                    draggedTask = tasksOnDay.find(t => t.name === taskName);
                    draggedTaskDate = dateStr;
                    
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            calendarGrid.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('task-indicator')) {
                    e.target.classList.remove('dragging');
                }
                
                // Remove drag-over class from all days
                document.querySelectorAll('.calendar-day').forEach(day => {
                    day.classList.remove('drag-over');
                });
            });

            calendarGrid.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dayEl = e.target.closest('.calendar-day');
                if (dayEl) {
                    dayEl.classList.add('drag-over');
                }
            });

            calendarGrid.addEventListener('dragleave', (e) => {
                const dayEl = e.target.closest('.calendar-day');
                if (dayEl && !dayEl.contains(e.relatedTarget)) {
                    dayEl.classList.remove('drag-over');
                }
            });

            calendarGrid.addEventListener('drop', (e) => {
                e.preventDefault();
                const dayEl = e.target.closest('.calendar-day');
                
                if (dayEl && draggedTask) {
                    const newDateStr = dayEl.getAttribute('data-date');
                    
                    if (newDateStr && newDateStr !== draggedTaskDate) {
                        // Update task date
                        const taskIndex = projectData.tasks.findIndex(t => t.id === draggedTask.id);
                        if (taskIndex !== -1) {
                            projectData.tasks[taskIndex].dueDate = new Date(newDateStr).toISOString();
                            renderCalendar();
                            updateProgressCircle();
                            
                            // Sync to Firebase
                            if (currentProjectId) {
                                updateFirebaseProject();
                            }
                        }
                    }
                }
                
                dayEl.classList.remove('drag-over');
                draggedTask = null;
                draggedTaskDate = null;
            });
        }
        
        // Verify all critical functions are defined
        console.log('ðŸ”§ Script loaded. Checking functions...');
        console.log('  approveTasks:', typeof window.approveTasks);
        console.log('  scrollToPage:', typeof window.scrollToPage);
        console.log('  renderCalendar:', typeof renderCalendar);
        
        if (typeof window.approveTasks === 'undefined') {
            console.error('âŒ approveTasks is undefined!');
        } else {
            console.log('âœ… All functions loaded successfully');
        }
        
        // ============================================
        // AI CHATBOT FOR TASK RESCHEDULING
        // ============================================
        
        let chatHistory = [];
        
        window.toggleChatbot = function() {
            const panel = document.getElementById('chatbotPanel');
            const button = document.getElementById('chatbotButton');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                button.style.transform = 'scale(0)';
                setTimeout(() => button.style.display = 'none', 200);
            } else {
                panel.style.display = 'none';
                button.style.display = 'flex';
                setTimeout(() => button.style.transform = 'scale(1)', 10);
            }
        };
        
        // ============================================
        // TO-DO SIDEBAR FUNCTIONS
        // ============================================
        
        let currentTodoMember = null;
        
        window.openTodoSidebar = function(memberName) {
            currentTodoMember = memberName;
            const sidebar = document.getElementById('todoSidebar');
            const overlay = document.getElementById('todoOverlay');
            const title = document.getElementById('todoTitle');
            
            title.textContent = `${memberName}'s Tasks`;
            
            // Populate tasks
            populateTodoList(memberName);
            
            sidebar.classList.add('open');
            overlay.classList.add('open');
        };
        
        window.closeTodoSidebar = function() {
            const sidebar = document.getElementById('todoSidebar');
            const overlay = document.getElementById('todoOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            currentTodoMember = null;
        };
        
        function populateTodoList(memberName) {
            const content = document.getElementById('todoContent');
            const tasks = projectData.tasks || [];
            
            // Get current date and end of week (next 7 days)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endOfWeek = new Date(today);
            endOfWeek.setDate(endOfWeek.getDate() + 7);
            
            // Filter tasks for this member (this week and upcoming)
            const memberTasks = tasks.filter(task => {
                if (task.assignee !== memberName && task.assignee !== 'Everyone') return false;
                if (task.name.toLowerCase().includes('rest day')) return false;
                return true;
            }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            // Split into this week and later
            const thisWeekTasks = memberTasks.filter(task => {
                const taskDate = new Date(task.dueDate);
                return taskDate >= today && taskDate <= endOfWeek;
            });
            
            const laterTasks = memberTasks.filter(task => {
                const taskDate = new Date(task.dueDate);
                return taskDate > endOfWeek;
            });
            
            if (memberTasks.length === 0) {
                content.innerHTML = `
                    <div class="todo-empty">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                        <p>No tasks assigned yet!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // This week's tasks
            if (thisWeekTasks.length > 0) {
                html += '<div class="todo-week-label">ðŸ“… This Week</div>';
                thisWeekTasks.forEach(task => {
                    html += createTodoItemHTML(task);
                });
            }
            
            // Later tasks
            if (laterTasks.length > 0) {
                html += '<div class="todo-week-label" style="margin-top: 1.5rem;">ðŸ“† Coming Up</div>';
                laterTasks.forEach(task => {
                    html += createTodoItemHTML(task);
                });
            }
            
            content.innerHTML = html;
        }
        
        function createTodoItemHTML(task) {
            const taskDate = new Date(task.dueDate);
            const dateStr = taskDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const isCompleted = task.completed;
            
            return `
                <div class="todo-item ${isCompleted ? 'completed' : ''}" data-task-id="${task.id}" onclick="toggleTodoTask('${task.id}')">
                    <div class="todo-checkbox ${isCompleted ? 'checked' : ''}">
                        ${isCompleted ? 'âœ“' : ''}
                    </div>
                    <div class="todo-item-content">
                        <div class="todo-item-name">${task.name}</div>
                        <div class="todo-item-date">${dateStr}</div>
                    </div>
                </div>
            `;
        }
        
        window.toggleTodoTask = function(taskId) {
            const task = projectData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const todoItem = document.querySelector(`.todo-item[data-task-id="${taskId}"]`);
            
            if (!task.completed) {
                // Mark as complete with animation
                task.completed = true;
                
                // Show "Done!" animation
                showDoneAnimation();
                
                // Animate the task item
                if (todoItem) {
                    todoItem.classList.add('completing');
                    
                    // Remove after animation
                    setTimeout(() => {
                        if (currentTodoMember) {
                            populateTodoList(currentTodoMember);
                        }
                    }, 500);
                }
                
                // Update progress circle
                updateProgressCircle();
                
                // Update calendar task appearance
                updateCalendarTaskAppearance(taskId, true);
                
                // Sync to Firebase if available
                if (window.syncToFirebase) {
                    syncToFirebase();
                }
            } else {
                // Unmark as complete
                task.completed = false;
                
                if (todoItem) {
                    const checkbox = todoItem.querySelector('.todo-checkbox');
                    checkbox.classList.remove('checked');
                    checkbox.textContent = '';
                    todoItem.classList.remove('completed');
                }
                
                // Update progress circle
                updateProgressCircle();
                
                // Update calendar task appearance
                updateCalendarTaskAppearance(taskId, false);
                
                // Sync to Firebase if available
                if (window.syncToFirebase) {
                    syncToFirebase();
                }
            }
        };
        
        function showDoneAnimation() {
            // Create confetti
            const colors = ['#FFB3E6', '#FFE5B3', '#B3D9FF', '#D4B3FF', '#B3FFD9', '#4A6B5A'];
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = (Math.random() * 100) + 'vw';
                confetti.style.top = '40vh';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                confetti.style.animation = `confettiFall ${Math.random() * 1 + 0.8}s ease-out forwards`;
                confetti.style.animationDelay = (Math.random() * 0.3) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 2000);
            }
            
            // Create main animation
            const doneEl = document.createElement('div');
            doneEl.className = 'done-animation';
            doneEl.innerHTML = `
                <div class="done-checkmark">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="done-text">Nice work! ðŸŽ‰</div>
                <div class="done-subtext">Keep it up!</div>
            `;
            document.body.appendChild(doneEl);
            
            setTimeout(() => {
                doneEl.remove();
            }, 1500);
        }
        
        function updateCalendarTaskAppearance(taskId, completed) {
            // Find the task element in the calendar and update its appearance
            const calendarTask = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
            if (calendarTask) {
                if (completed) {
                    calendarTask.style.opacity = '0.5';
                    calendarTask.style.textDecoration = 'line-through';
                } else {
                    calendarTask.style.opacity = '1';
                    calendarTask.style.textDecoration = 'none';
                }
            }
        }
        
        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingId = addChatMessage('Thinking...', 'assistant', true);
            
            try {
                // Check if user wants to change/rename a task
                const changeMatch = message.match(/change|rename|edit|update/i);
                const toMatch = message.match(/to\s+["']?([^"']+)["']?\s*$/i);
                
                // Simple pattern matching for task rescheduling
                const taskMatch = message.match(/task (\d+)|(\d+)(?:st|nd|rd|th)?\s+task/i);
                const dateMatch = message.match(/thursday|friday|saturday|sunday|monday|tuesday|wednesday|tomorrow|next week/i);
                
                // Also check for task names
                let taskIndex = -1;
                if (taskMatch) {
                    taskIndex = parseInt(taskMatch[1] || taskMatch[2]) - 1;
                } else {
                    // Search by task name
                    const lowerMessage = message.toLowerCase();
                    taskIndex = projectData.tasks.findIndex(t => 
                        lowerMessage.includes(t.name.toLowerCase().substring(0, 15))
                    );
                }
                
                removeChatMessage(typingId);
                
                // Handle task name change
                if (changeMatch && taskIndex >= 0 && toMatch) {
                    const task = projectData.tasks[taskIndex];
                    const oldName = task.name;
                    const newName = toMatch[1].trim();
                    task.name = newName;
                    
                    // Update Firebase
                    if (currentProjectId) {
                        await updateFirebaseProject();
                        addChatMessage(`Done - renamed "${oldName}" to "${newName}". Your team will see this change.`, 'assistant');
                    } else {
                        addChatMessage(`Done - renamed "${oldName}" to "${newName}".`, 'assistant');
                    }
                    
                    // Refresh calendar
                    if (window.currentPage === 8) {
                        renderCalendar();
                    }
                    return;
                }
                
                // Handle task reschedule
                if (taskIndex >= 0 && taskIndex < projectData.tasks.length && dateMatch) {
                    // Calculate new date
                    const today = new Date();
                    const dayMap = {
                        'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4,
                        'friday': 5, 'saturday': 6, 'sunday': 0
                    };
                    
                    let newDate = new Date();
                    const dayName = dateMatch[0].toLowerCase();
                    
                    if (dayName === 'tomorrow') {
                        newDate.setDate(today.getDate() + 1);
                    } else if (dayName === 'next week') {
                        newDate.setDate(today.getDate() + 7);
                    } else if (dayMap[dayName] !== undefined) {
                        // Find next occurrence of that day
                        const targetDay = dayMap[dayName];
                        const currentDay = today.getDay();
                        let daysToAdd = targetDay - currentDay;
                        if (daysToAdd <= 0) daysToAdd += 7;
                        newDate.setDate(today.getDate() + daysToAdd);
                    }
                    
                    // Update task
                    const task = projectData.tasks[taskIndex];
                    const oldDate = new Date(task.dueDate).toLocaleDateString();
                    task.dueDate = newDate.toISOString();
                    
                    // Update Firebase
                    if (currentProjectId) {
                        await updateFirebaseProject();
                        addChatMessage(`Done - moved "${task.name}" from ${oldDate} to ${newDate.toLocaleDateString()}. Your team will see this update.`, 'assistant');
                        
                        // Refresh calendar
                        if (window.currentPage === 8) {
                            renderCalendar();
                        }
                    } else {
                        addChatMessage(`Done - moved "${task.name}" to ${newDate.toLocaleDateString()}.`, 'assistant');
                        if (window.currentPage === 8) {
                            renderCalendar();
                        }
                    }
                } else if (taskIndex >= 0) {
                    const task = projectData.tasks[taskIndex];
                    addChatMessage(`Found "${task.name}" (Task ${taskIndex + 1}). What would you like to do?\n\nReschedule: "Move to Friday"\nRename: "Change to New Task Name"`, 'assistant');
                } else if (dateMatch) {
                    addChatMessage(`Got it - ${dateMatch[0]}. Which task?\n\nTry: "Move task 5 to ${dateMatch[0]}"`, 'assistant');
                } else if (changeMatch) {
                    addChatMessage(`To rename a task, tell me which one and the new name.\n\nExample: "Change task 3 to Write Report Draft"`, 'assistant');
                } else {
                    // List available tasks
                    const taskList = projectData.tasks.slice(0, 5).map((t, i) => `${i + 1}. ${t.name}`).join('\n');
                    addChatMessage(`Here are your first few tasks:\n\n${taskList}\n\nYou can:\n- Reschedule: "Move task 3 to Friday"\n- Rename: "Change task 2 to New Name"`, 'assistant');
                }
                
            } catch (error) {
                console.error('Chatbot error:', error);
                removeChatMessage(typingId);
                addChatMessage("Sorry, I had trouble understanding that. Try: 'Move task 3 to Thursday' or 'Reschedule task 5 to next week'", 'assistant');
            }
        };
        
        // Quick chat option buttons
        window.selectChatOption = function(option) {
            const input = document.getElementById('chatInput');
            if (option === 'reschedule') {
                addChatMessage("I want to reschedule a task", 'user');
                setTimeout(() => {
                    addChatMessage("Which task would you like to reschedule? You can say something like:\n\nâ€¢ \"Move Draft Slide 3 to Friday\"\nâ€¢ \"Reschedule the meeting to next Tuesday\"\nâ€¢ \"Push Research task to the 15th\"", 'assistant');
                }, 500);
            } else if (option === 'rename') {
                addChatMessage("I want to rename a task", 'user');
                setTimeout(() => {
                    addChatMessage("Which task would you like to rename? You can say something like:\n\nâ€¢ \"Rename Draft Slide 3 to Create Introduction\"\nâ€¢ \"Change Research task to Literature Review\"", 'assistant');
                }, 500);
            }
            input.focus();
        };
        
        function addChatMessage(text, role, isTyping = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now();
            
            const isUser = role === 'user';
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.cssText = `
                background: ${isUser ? '#4A6B5A' : 'white'};
                color: ${isUser ? 'white' : '#1F2937'};
                padding: 0.75rem 1rem;
                border-radius: 12px;
                max-width: 80%;
                align-self: ${isUser ? 'flex-end' : 'flex-start'};
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                animation: slideIn 0.2s ease-out;
            `;
            
            if (!isUser && !isTyping) {
                const label = document.createElement('div');
                label.style.cssText = 'font-size: 0.75rem; color: #9CA3AF; margin-bottom: 0.25rem;';
                label.textContent = 'Talli';
                messageDiv.appendChild(label);
            }
            
            const textDiv = document.createElement('div');
            textDiv.style.cssText = 'white-space: pre-wrap;';
            textDiv.textContent = text;
            messageDiv.appendChild(textDiv);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageId;
        }
        
        function removeChatMessage(messageId) {
            const msg = document.getElementById(messageId);
            if (msg) msg.remove();
        }

    </script>
    <!-- Referral Popup -->
    <div id="referralPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: var(--bg); padding: 2.5rem; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative;">
            <span onclick="closeReferralPopup()" style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--text-light); font-weight: bold;">Ã—</span>
            
            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸŽ‰</div>
            <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-bottom: 1rem;">Project Created!</h2>
            <p style="color: var(--text); font-size: 1.1rem; margin-bottom: 2rem;">Share with your teammates so they can add their own strengths & availability</p>
            
            <div style="background: rgba(74, 107, 90, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                <input 
                    id="shareLink" 
                    type="text" 
                    readonly 
                    value="" 
                    style="flex: 1; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; background: var(--bg); color: var(--text);"
                >
                <button onclick="copyShareLink()" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                    Copy Link
                </button>
            </div>
            
            <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1.5rem;">When they click the link, they'll go straight to adding their details!</p>
            
            <button onclick="closeReferralPopup()" style="width: 100%; padding: 1rem; background: var(--secondary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 1.05rem; cursor: pointer;">
                Got it!
            </button>
        </div>
    </div>

    <!-- AI Chatbot Widget (only visible on calendar page) -->
    <div id="chatbotButton" onclick="toggleChatbot()" style="display: none; position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: #4A6B5A; border-radius: 50%; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(74, 107, 90, 0.3); z-index: 9999; transition: all 0.3s;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </div>

    <!-- Chatbot Panel -->
    <div id="chatbotPanel" style="display: none; position: fixed; bottom: 2rem; right: 2rem; width: 380px; height: 550px; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); z-index: 10000; flex-direction: column; overflow: hidden;">
        <!-- Header -->
        <div style="background: #4A6B5A; color: white; padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <div>
                    <div style="font-weight: 700; font-size: 1.1rem;">Quick Help</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Reschedule or rename tasks</div>
                </div>
            </div>
            <button onclick="toggleChatbot()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">Ã—</button>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1rem; background: #f9fafb; display: flex; flex-direction: column; gap: 1rem;">
            <div style="background: white; padding: 0.75rem 1rem; border-radius: 12px; max-width: 85%; align-self: flex-start; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="font-size: 0.75rem; color: #9CA3AF; margin-bottom: 0.25rem;">Talli</div>
                <div style="color: #1F2937; margin-bottom: 0.75rem;">What would you like to do?</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="selectChatOption('reschedule')" class="chat-quick-btn" style="background: #E8F5E9; color: #2F4538; border: 2px solid #4A6B5A; border-radius: 20px; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        ðŸ“… Reschedule a task
                    </button>
                    <button onclick="selectChatOption('rename')" class="chat-quick-btn" style="background: #E8F5E9; color: #2F4538; border: 2px solid #4A6B5A; border-radius: 20px; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        âœï¸ Rename a task
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div style="padding: 1rem; border-top: 1px solid #E5E7EB; background: white;">
            <div style="display: flex; gap: 0.5rem;">
                <input 
                    id="chatInput" 
                    type="text" 
                    placeholder="Or type your request here..." 
                    onkeypress="if(event.key==='Enter') sendChatMessage()"
                    style="flex: 1; padding: 0.75rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.9rem; outline: none; transition: border 0.2s;"
                    onfocus="this.style.borderColor='#4A6B5A'"
                    onblur="this.style.borderColor='#E5E7EB'"
                >
                <button onclick="sendChatMessage()" style="background: #4A6B5A; color: white; border: none; border-radius: 8px; padding: 0.75rem 1.25rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- To-Do Sidebar Overlay -->
    <div class="todo-overlay" id="todoOverlay" onclick="closeTodoSidebar()"></div>

    <!-- To-Do Sidebar -->
    <div class="todo-sidebar" id="todoSidebar">
        <div class="todo-header">
            <h3 id="todoTitle">My Tasks</h3>
            <button class="todo-close" onclick="closeTodoSidebar()">Ã—</button>
        </div>
        <div class="todo-content" id="todoContent">
            <!-- Tasks will be populated here -->
        </div>
    </div>

</body>
</html>
